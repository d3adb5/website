<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I&rsquo;ve been using computers for quite some time. Though BBSes, Usenet, IRC, and
many forums came way before I was even born &mdash; I&rsquo;m relatively young, come on
&mdash; I was a netizen before the shift towards video conferencing and voice
calls. Consequently I grew up primarily using the keyboard to communicate with
people online. Growing up in Brazil, I was raised using the modern ABNT2
keyboard layout to type Portuguese, and that has sadly stuck with me."><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>How a keyboard layout ruined my daily life</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href=/ class=[]>Home
</a><a href=/blog/ class=[]>Blog
</a><a href=/glob/ class=[]>Glob
</a><a href=/projects/ class=[]>Projects
</a><a href=/about/ class=push-right>About</a></nav><main role=main><article id=content><header><section class=header-line><h1>How a keyboard layout ruined my daily life</h1></section><section class=subheader-line><p class=subtitle>A cautionary tale of adhering to standards</p><ul id=article-tags><li><a href=/tags/rants>Rants</a></li><li><a href=/tags/technology>Technology</a></li><li><a href=/tags/linux>Linux</a></li><li><a href=/tags/keyboards>Keyboards</a></li></ul></section></header><input type=checkbox id=toc-toggle-box>
<label for=toc-toggle-box id=toc-toggle><em>• Table of Contents •</em></label><nav id=TableOfContents><ul><li><a href=#br-abnt2-us-ansi-and-me>BR ABNT2, US ANSI, and me</a><ul><li><a href=#improvise-adapt-overcome>Improvise, adapt, overcome</a></li></ul></li><li><a href=#implementing-a-layout>Implementing a layout</a><ul><li><a href=#the-old-fashioned-way-xmodmap>The old fashioned way: xmodmap</a></li><li><a href=#x-keyboard-extension-xkb>X Keyboard Extension (XKB)</a></li><li><a href=#then-fcitx5-came-along>Then Fcitx5 came along</a></li></ul></li><li><a href=#the-bazaar-with-landmines>The Bazaar with Landmines</a><ul><li><a href=#adding-a-variant-to-the-us-layout>Adding a variant to the US layout</a></li><li><a href=#automating-for-future-reference>Automating for future reference</a><ul><li><a href=#2023-08-26-update-an-ansible-playbook>2023-08-26 Update: an Ansible playbook</a></li></ul></li></ul></li></ul></nav><p>I&rsquo;ve been using computers for quite some time. Though BBSes, Usenet, IRC, and
many forums came way before I was even born &mdash; I&rsquo;m relatively young, come on
&mdash; I was a netizen before the shift towards video conferencing and voice
calls. Consequently I grew up primarily using the keyboard to communicate with
people online. <em>Growing up in Brazil,</em> I was raised using the <em>modern ABNT2
keyboard layout</em> to type Portuguese, and that has sadly stuck with me.</p><p>The keyboard with which I am typing this article is a <em>US ANSI</em> keyboard, <strong>but
you can type on it as though it were ABNT2.</strong> The reason for that lies in the
fact that instead of using the <em>US International</em> layout, like most reasonable
people would, I changed the original layout&rsquo;s keymap just enough to resemble
ABNT2.</p><p>Looking back on it, it was a terrible idea. I&rsquo;m confident I could switch to a
keyboard layout that actually resembles the labels on the keycaps, and that my
wife could use when she needs to use my computer, <em>but it&rsquo;s awkward and I don&rsquo;t
want to!</em> What I have has been working fine for me for the better part of 2
years, and I&rsquo;m not ready to jump ship yet, especially given it&rsquo;ll be a
hindrance at work and I&rsquo;ll have to climb up the learning curve.</p><h2 id=br-abnt2-us-ansi-and-me>BR ABNT2, US ANSI, and me</h2><p>Let&rsquo;s back up a bit and talk about the ABNT2 (ISO) and US ANSI layouts. That&rsquo;ll
help paint an accurate picture of what typing is like for most Brazilians, most
Americans, and then me. Below you&rsquo;ll find the ABNT2 layout, which has an ISO
Enter key &mdash; i.e. a &ldquo;vertical&rdquo; one that looks like a boot.</p><p>It&rsquo;s a QWERTY layout that includes a <em><code>Ç</code></em> key, as the grapheme is present in
Brazilian Portuguese, and moves diacritics around a bit due to their prominence
in our language. They&rsquo;re concentrated on the right side of the keyboard, and
are shown in the picture in red.</p><figure><a href=/media/abnt2-keyboard.webp><img src=/media/abnt2-keyboard.webp alt="The keyboard layout used by the majority of Brazilians."></a><figcaption><p>The keyboard layout used by the majority of Brazilians.</p></figcaption></figure><p>It is important to have these diacritics easily accessible so we can quickly
type words like <em>ímã, mérito, coração,</em> and <em>àquela</em> without having to move our
hands around too much. Try to imagine how these would be typed in the US ANSI
International keyboard layout.</p><p>I grew up typing on this type of keyboard, so I&rsquo;m very used to it. And then I
was introduced to the world of mechanical keyboards, where boards use the US
layout for the most part, with ANSI being the most common variation for smaller
keyboards. Below is what a 60% US ANSI keyboard looks like. My current
keyboard, sized 65%, is not too different.</p><figure><a href=/media/ansi-keyboard.webp><img src=/media/ansi-keyboard.webp alt="The keyboard layout used by the majority of Americans."></a><figcaption><p>The keyboard layout used by the majority of Americans.</p></figcaption></figure><p>I wanted a nice mechanical keyboard, but also a small one, as no matter how
clean my desk is, it&rsquo;s always too small. My wife gifted me a TOFU65, a 65%
keyboard that uses the US ANSI layout. Its only real difference from the
standard 60% US ANSI layout is the inclusion of arrow keys and an extra column
of keys on the right side of the keyboard, giving us 4 extra keys.</p><p>On my keyboard, these extra keys are, top to bottom, <em>Home, PgUp, PgDown,</em> and
<em>Del.</em></p><h3 id=improvise-adapt-overcome>Improvise, adapt, overcome</h3><p>I guess I&rsquo;m still at the &ldquo;improvise&rdquo; stage, since I&rsquo;m bending the keyboard to
my will instead of adapting to a widely used international layout. Purely out
of laziness, might I add, as many people are more than comfortable typing
Portuguese and other languages with widespread diacritics on a US International
layout with dead keys.</p><p>This is when I show you what my typing experience looks like, after
superimposing the ABNT2 layout on top of the US ANSI one, making <em>Caps Lock</em>
into a dual function key providing both <em>Ctrl</em> and <em>Esc</em>, and making <em>Tab</em> a
dual function key providing both <em>Super / Win</em> &mdash; my XMonad modifier &mdash; and
<em>Tab</em> itself.</p><figure><a href=/media/my-custom-layout.webp><img src=/media/my-custom-layout.webp alt="Sorry for the mixture of image resolutions, I did my best."></a><figcaption><p>Sorry for the mixture of image resolutions, I did my best.</p></figcaption></figure><p>For those wondering about some missing symbols that are ever present in daily
conversation and important documents: <em><code>/?|\</code></em> are all accessible through layer
3, activated by holding down the <em>Alt Gr</em> key. This is not default behavior on
US ANSI, as far as I&rsquo;m aware, at least not for <em>Z</em> and <em>X,</em> so it had to be
built into the layout as well.</p><p>This is essentially an entirely new ANSI keyboard layout for comfortably
migrating from ABNT2 to US ANSI, with added steroids in the form of additional
functionality. <em>It&rsquo;s not perfect, but it works well for me.</em></p><h2 id=implementing-a-layout>Implementing a layout</h2><p>Designing the keyboard layout itself is easy. The difficult part is actually
adding it to X11 &mdash; we&rsquo;re avoiding Wayland and other operating systems &mdash; but
what if we don&rsquo;t have to write the layout from scratch? The X.Org project has a
program called <em>xmodmap,</em> which allows us to alter the <em>keycode</em> to <em>keysym</em>
mapping that is performed by X11 in real time.</p><p>For a little bit of context, the keyboard sends <em>scancodes</em> to the Linux
kernel, which translates them to <em>keycodes,</em> and subsequently X11, through the
current layout&rsquo;s <em>keymap,</em> translates them to <em>keysyms.</em> These are things like
<code>a</code>, <code>tilde</code>, <code>deadtilde</code>, etc. The keymap is what we make changes to in real
time through <em>xmodmap.</em></p><h3 id=the-old-fashioned-way-xmodmap>The old fashioned way: xmodmap</h3><p>You can find these instructions by looking up <em>&ldquo;xmodmap&rdquo;</em> and going through the
first couple of results. Regardless, I&rsquo;m going to place it here for reference.
The first thin you want to do is <em>dump the current map to a file:</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>xmodmap -pke &gt; current-keymap
</span></span></code></pre></div><p>The file the above command produces will have <strong>a lot of lines,</strong> most of which
are not going to be relevant to your use case. Use it to find the keys you want
to change through their current <em>keysyms.</em> Here are a few examples:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>keycode  20 = minus underscore minus underscore
</span></span><span style=display:flex><span>keycode  21 = equal plus equal plus
</span></span><span style=display:flex><span>keycode  22 = BackSpace BackSpace BackSpace BackSpace
</span></span></code></pre></div><p>Each token after the equals sign in the lines above corresponds to a <em>keysym,</em>
subsequently reachable through the keyboard <em>layer</em> of the same index in the
line&rsquo;s order. I&rsquo;m going to skip the technicalities here &mdash; please forgive me,
keyboard enthusiasts and X11 connoisseurs &mdash; and just say that <em>the first
three layers are really the relevant ones:</em></p><ol><li>The first layer is what you get with a simple key press.</li><li>The second layer is what you get when you press the key while holding down
<em>Shift.</em></li><li>The third layer is what you get when you press the key while holding the
compose key, which for ABNT2 is <em>Alt Gr.</em></li></ol><p>So just change the lines you need to, <strong>and delete everything else.</strong> You can
then place the file somewhere like <code>~/.Xmodmap</code> (convention) and source it in
your X11 init script (<code>~/.xinitrc</code>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>xmodmap ~/.Xmodmap
</span></span><span style=display:flex><span><span style=color:#75715e># ...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exec xmonad
</span></span></code></pre></div><h3 id=x-keyboard-extension-xkb>X Keyboard Extension (XKB)</h3><p>I had some problems with <em>Fcitx4,</em> an input management engine, mangling the
layers and somehow pushing me to layer 3 without pressing any modifiers.
Looking up known issues between <em>Fcitx</em> and <em>xmodmap,</em> I found out that the
latter is now considered an old fashioned, outdated way to modify keymaps.
Instead, we should be using the <em>X Keyboard Extension (XKB).</em></p><p>XKB is a new way to define keyboard layouts, separating them into keycodes,
types, compatibility, geometry, symbols, and rules. You can find all of this
information in the necessary syntax through <em>xkbcomp,</em> luckily, so one could
use this in a similar way to <em>xmodmap!</em> Execute the following command to dump
the current layout information:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>xkbcomp -xkb <span style=color:#e6db74>&#34;</span>$DISPLAY<span style=color:#e6db74>&#34;</span> -o current-layout.xkb
</span></span></code></pre></div><p>Just like with <em>xmodmap,</em> you can discard most of the file and keep only what
is relevant to you. There are better guides to do this elsewhere on the
Internet, but at least with XKB you can use <em><code>include</code></em> to essentially inherit
settings from other layouts. The following is what I ended up with, and it
should theoretically define a full keyboard layout:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>xkb_keymap {
</span></span><span style=display:flex><span>  xkb_keycodes      { include &#34;evdev+aliases(qwerty)&#34; };
</span></span><span style=display:flex><span>  xkb_types         { include &#34;complete&#34;              };
</span></span><span style=display:flex><span>  xkb_compatibility { include &#34;complete&#34;              };
</span></span><span style=display:flex><span>  xkb_geometry      { include &#34;pc(pc105)&#34;             };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  xkb_symbols {
</span></span><span style=display:flex><span>    include &#34;pc+us+inet(evdev)+level3(ralt_switch)&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name[group1] = &#34;Custom English (US)&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override key &lt;AE06&gt; { [ 6,            dead_diaeresis ] };
</span></span><span style=display:flex><span>    override key &lt;AB10&gt; { [ semicolon,    colon ] };
</span></span><span style=display:flex><span>    override key &lt;AD11&gt; { [ dead_acute,   dead_grave,      degree ] };
</span></span><span style=display:flex><span>    override key &lt;AD12&gt; { [ bracketleft,  braceleft,       guillemotleft ] };
</span></span><span style=display:flex><span>    override key &lt;BKSL&gt; { [ bracketright, braceright,      guillemotright ] };
</span></span><span style=display:flex><span>    override key &lt;AC10&gt; { [ ccedilla,     Ccedilla,        bar ] };
</span></span><span style=display:flex><span>    override key &lt;AC11&gt; { [ dead_tilde,   dead_circumflex, backslash ] };
</span></span><span style=display:flex><span>    override key &lt;CAPS&gt; { [ apostrophe,   quotedbl,        grave ] };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    override key &lt;AD01&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ q, Q, slash ] };
</span></span><span style=display:flex><span>    override key &lt;AD02&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ w, W, question ] };
</span></span><span style=display:flex><span>    override key &lt;AC01&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ a, A, colon ] };
</span></span><span style=display:flex><span>    override key &lt;AC02&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ s, S, semicolon ] };
</span></span><span style=display:flex><span>    override key &lt;AB01&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ z, Z, backslash ] };
</span></span><span style=display:flex><span>    override key &lt;AB02&gt; { type = &#34;THREE_LEVEL&#34;, symbols[Group1] = [ x, X, bar ] };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>For packaged X11 keyboard layouts, these blocks are defined in separate files
under <code>/usr/share/X11/xkb</code>, if you&rsquo;re curious about them. Place the above
configuration in a <code>~/.config/xkb/custom.xkb</code> file and you can load it onto the
display server in your <code>.xinitrc</code> with the following command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>xkbcomp ~/.config/xkb/custom.xkb <span style=color:#e6db74>&#34;</span>$DISPLAY<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>And I thought that would&rsquo;ve been the end of it, but&mldr;</p><h3 id=then-fcitx5-came-along>Then Fcitx5 came along</h3><p>Researching into this, I found out that <em>Fcitx4</em> is now in maintenance mode,
and <em>Fcitx5</em> is ready for production use. &ldquo;Perhaps this is going to solve all
of my problems,&rdquo; I thought. I was wrong, it created a new one: when rebuilding
device information or seemingly at random, <em>Fcitx5</em> would revert the active
keymap to the one defined by the layout &mdash; thereby forcing me to reapply the
one I made with <em>xkbcomp.</em></p><p>It seems it&rsquo;ll apply whatever the currently active layout uses as determined by
Fcitx&rsquo; configuration, and no matter how much I looked into making it use what I
wrote, my one and only option seemed to be <strong>to add my own layout to X11.</strong></p><h2 id=the-bazaar-with-landmines>The Bazaar with Landmines</h2><p>In <a href=https://danijozsef.medium.com/the-bazaar-with-landmines-or-how-to-extend-xkb-the-right-way-b82de59a1f9a>The Bazaar with Landmines (or How To Extend XKb the Right Way)</a>, Dani
Jozsef outlines and explains the shortcomings of combining the X Keyboard
Extension with the traditional style of package management conducted by most
GNU/Linux distributions. The summary is that because layouts are indexed in
aggregate files under <code>/usr/share/X11/xkb</code>, any changes made to them to add or
remove keyboard layouts will be overwritten by the next update to the package
that includes those files.</p><p>I&rsquo;m currently using Arch Linux, where <code>evdev.xml</code> and company are packaged by
<code>xkeyboard-config</code>, so I could prevent updates to the files I&rsquo;d need to change
by adding <code>xkeyboard-config</code> to the <code>IgnorePkg</code> list in <code>/etc/pacman.conf</code>.
Let&rsquo;s explore this avenue to see if it&rsquo;s worth it, and prepare for the future
with something of an install script.</p><h3 id=adding-a-variant-to-the-us-layout>Adding a variant to the US layout</h3><p>The first thing we need to do is pretty simple: take the file currently being
read by <code>xkbcomp</code>, extract its <code>xkb_symbols</code> block, add a variant name to it
&mdash; meaning we change <code>xkb_symbols</code> to something like <code>xkb_symbols "abnt2"</code> &mdash;
and append its new contents to the <code>/usr/share/X11/xkb/symbols/us</code> file.
Effectively, <em>this adds a new symbols variant to the US layout!</em></p><p>But now we need to make sure that X11 knows about our new variant, which is
done by editing the following files:</p><ul><li><code>/usr/share/X11/xkb/rules/evdev.xml</code></li><li><code>/usr/share/X11/xkb/rules/base.xml</code></li><li><code>/usr/share/X11/xkb/rules/evdev.lst</code></li><li><code>/usr/share/X11/xkb/rules/base.lst</code></li></ul><p>For this I just followed in the footsteps of already established variants of
the same layout, such as the Cherokee one, and came up with the following XML
excerpt to place at the start of the variants list:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;variant&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;configItem&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;name&gt;</span>abnt2<span style=color:#f92672>&lt;/name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&lt;!-- ABNT2 mixture into US ANSI --&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;shortDescription&gt;</span>abnt2<span style=color:#f92672>&lt;/shortDescription&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;description&gt;</span>ABNT2<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;languageList&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;iso639Id&gt;</span>pt<span style=color:#f92672>&lt;/iso639Id&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;/languageList&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/configItem&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/variant&gt;</span>
</span></span></code></pre></div><p>And in the case of the <code>.lst</code> files, it&rsquo;s a single line next to <code>! variant</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>  ! variant
</span></span><span style=display:flex><span><span style=color:#a6e22e>+   abnt2           us: ABNT2
</span></span></span><span style=display:flex><span>    chr             us: Cherokee
</span></span></code></pre></div><p>With these changes made, a restart of the X server made it possible to select
the variant with <code>setxkbmap -layout us -variant abnt2</code>, so I switched over to
it for my default layout through <code>localectl</code>. That had to be mirrored on the
Fcitx5 side, which was a whole ordeal given that Fcitx can&rsquo;t seem to list my
layouts anymore? <em>Maybe I did something wrong, but I&rsquo;m not sure what.</em></p><h3 id=automating-for-future-reference>Automating for future reference</h3><p>Finally, we need to create a script that installs the layout variant and adds
it to the files we changed, so we don&rsquo;t need to repeat this process manually.
It is really simple, and necessitates only <code>patch</code>, found in <code>base-devel</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/sh
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>workspace<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>readonly workspace patchFile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> symbolsFile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>$2<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>trap -- <span style=color:#e6db74>&#34;rm -rf -- &#39;</span>$workspace<span style=color:#e6db74>&#39;&#34;</span> EXIT INT HUP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>id -u<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> !<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;This script needs to be executed by root.&#34;</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> ! command -v patch &gt;/dev/null 2&gt;&amp;1; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;This script requires the patch command.&#34;</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cp <span style=color:#e6db74>&#34;</span>$patchFile<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$symbolsFile<span style=color:#e6db74>&#34;</span> -t <span style=color:#e6db74>&#34;</span>$workspace<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tee -a /usr/share/X11/xkb/symbols/us &lt; <span style=color:#e6db74>&#34;</span>$workspace<span style=color:#e6db74>/</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$symbolsFile<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>cd /usr/share/X11/xkb/rules <span style=color:#f92672>&amp;&amp;</span> patch -p1 &lt; <span style=color:#e6db74>&#34;</span>$workspace<span style=color:#e6db74>/</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$patchFile<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>And then all I needed to do was create the patch file. It&rsquo;s a simple <code>diff -crB</code>, and after removing repeated changes, it looks something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff -crB a/evdev.lst b/evdev.lst
</span></span><span style=display:flex><span>*** a/evdev.lst	2023-06-30 15:44:42.663986335 -0700
</span></span><span style=display:flex><span><span style=color:#f92672>--- b/evdev.lst	2023-06-30 15:44:06.860921275 -0700
</span></span></span><span style=display:flex><span>***************
</span></span><span style=display:flex><span>*** 292,297 ****
</span></span><span style=display:flex><span><span style=color:#f92672>--- 292,298 ----
</span></span></span><span style=display:flex><span>    custom          A user-defined custom Layout
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  ! variant
</span></span><span style=display:flex><span><span style=color:#a6e22e>+   abnt2           us: ABNT2
</span></span></span><span style=display:flex><span>    chr             us: Cherokee
</span></span><span style=display:flex><span>    haw             us: Hawaiian
</span></span><span style=display:flex><span>    euro            us: English (US, euro on 5)
</span></span><span style=display:flex><span>diff -crB a/evdev.xml b/evdev.xml
</span></span><span style=display:flex><span>*** a/evdev.xml	2023-06-30 15:34:06.768592466 -0700
</span></span><span style=display:flex><span><span style=color:#f92672>--- b/evdev.xml	2023-06-30 15:33:52.034551239 -0700
</span></span></span><span style=display:flex><span>***************
</span></span><span style=display:flex><span>*** 1358,1363 ****
</span></span><span style=display:flex><span><span style=color:#f92672>--- 1358,1374 ----
</span></span></span><span style=display:flex><span>        &lt;variantList&gt;
</span></span><span style=display:flex><span>          &lt;variant&gt;
</span></span><span style=display:flex><span>            &lt;configItem&gt;
</span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;name&gt;abnt2&lt;/name&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;!-- ABNT2 mixture into US ANSI --&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;shortDescription&gt;abnt2&lt;/shortDescription&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;description&gt;ABNT2&lt;/description&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;languageList&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+               &lt;iso639Id&gt;pt&lt;/iso639Id&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+             &lt;/languageList&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+           &lt;/configItem&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         &lt;/variant&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+         &lt;variant&gt;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+           &lt;configItem&gt;
</span></span></span><span style=display:flex><span>              &lt;name&gt;chr&lt;/name&gt;
</span></span><span style=display:flex><span>              &lt;!-- Keyboard indicator for Cherokee layouts --&gt;
</span></span><span style=display:flex><span>              &lt;shortDescription&gt;chr&lt;/shortDescription&gt;
</span></span></code></pre></div><p>And voilà, it&rsquo;s done. <strong>Now let&rsquo;s hope Fcitx5 just works.</strong></p><h4 id=2023-08-26-update-an-ansible-playbook>2023-08-26 Update: an Ansible playbook</h4><p>Automation is great. Proper automation is better. Offloading effort to a tool
while declaring intent is the best, which is why in this day and age we write
declarative code and use convergence tools like Ansible. So forget the earlier
patch and script, and use this thing I just wrote, which you can run as many
times as you wish, to guarantee your variant of a given layout is present in
your system:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install custom keyboard variant</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>become</span>: <span style=color:#66d9ef>yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>vars</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>keyboard_layout</span>: <span style=color:#ae81ff>us</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>keyboard_variant</span>: <span style=color:#ae81ff>abnt2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>keyboard_symbols_filepath</span>: <span style=color:#ae81ff>./symbols.xkb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>x11_xkb_dir</span>: <span style=color:#ae81ff>/usr/share/X11/xkb</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Read contents of symbols file</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.set_fact</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>custom_symbols</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, keyboard_symbols_filepath) }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure variant symbols is present</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.blockinfile</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/symbols/{{ keyboard_layout }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>block</span>: <span style=color:#e6db74>&#34;{{ custom_symbols }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>marker</span>: <span style=color:#e6db74>&#34;// {mark} ANSIBLE MANAGED BLOCK - {{ keyboard_variant }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Ensure variant is present in rules/base.lst and rules/evdev.lst</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.lineinfile</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>line</span>: <span style=color:#e6db74>&#34;  {{ keyboard_variant }} {{ keyboard_layout }}: {{ keyboard_variant | upper }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>insertafter</span>: <span style=color:#e6db74>&#34;^! variant&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/evdev.lst&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/base.lst&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Check for existing variant entry in list</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>community.general.xml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>xpath</span>: <span style=color:#e6db74>&#34;/xkbConfigRegistry/layoutList/layout\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                /configItem[name=&#39;{{ keyboard_layout }}&#39;]/..\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                /variantList/variant/configItem[name=&#39;{{ keyboard_variant }}&#39;]&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>count</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>register</span>: <span style=color:#ae81ff>xml_read</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/evdev.xml&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/base.xml&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Gather query results into dictionary</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.set_fact</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>matches</span>: <span style=color:#e6db74>&#34;{{ xml_read.results | items2dict(key_name=&#39;item&#39;, value_name=&#39;count&#39;) }}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Add variant to rules/base.xml and rules/evdev.xml</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>when</span>: <span style=color:#ae81ff>matches[item] == 0</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>community.general.xml</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>path</span>: <span style=color:#e6db74>&#34;{{ item }}&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>xpath</span>: <span style=color:#e6db74>&#34;/xkbConfigRegistry/layoutList/layout\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                /configItem[name=&#39;{{ keyboard_layout }}&#39;]/..\
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                /variantList&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>pretty_print</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>add_children</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>variant</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>_</span>:
</span></span><span style=display:flex><span>                - <span style=color:#f92672>configItem</span>:
</span></span><span style=display:flex><span>                    <span style=color:#f92672>_</span>:
</span></span><span style=display:flex><span>                      - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;{{ keyboard_variant }}&#34;</span>
</span></span><span style=display:flex><span>                      - <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#34;{{ keyboard_variant | upper }}&#34;</span>
</span></span><span style=display:flex><span>                      - <span style=color:#f92672>languageList</span>:
</span></span><span style=display:flex><span>                          <span style=color:#f92672>_</span>:
</span></span><span style=display:flex><span>                            - <span style=color:#f92672>iso639Id</span>: <span style=color:#ae81ff>eng</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>state</span>: <span style=color:#ae81ff>present</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>loop</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/evdev.xml&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;{{ x11_xkb_dir }}/rules/base.xml&#34;</span>
</span></span></code></pre></div></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/0075a3c7507bbb4ca1c683cea8feb50563eef375><span class=commit-hash>0075a3c</span><span class=commit-subject>content(blog): add xkb ansible playbook to article</span></a></p><p id=timestamp>Updated August 26, 2023</p></footer></body></html>