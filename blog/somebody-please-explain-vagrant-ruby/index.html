<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='I took up a position with a new company that involves the use of SaltStack.
Since I&rsquo;d never used it before, I decided to try my hand at setting up a proof
of concept, and for that I wanted to use multiple machines. So I decided to use
Vagrant, another tool I&rsquo;m not familiar with, to declaratively spin up a few
VMs.
This is what I first tried:
machines = {
  master:   { box: "bento/ubuntu-22.04", master: true  },
  superior: { box: "bento/ubuntu-22.04", master: false },
  michigan: { box: "bento/ubuntu-22.04", master: false },
  ontario:  { box: "bento/ubuntu-22.04", master: false },
  erie:     { box: "bento/ubuntu-22.04", master: false },
  huron:    { box: "bento/ubuntu-22.04", master: false }
}

Vagrant.configure("2") do |config|
  for hostname, options in machines
    config.vm.define hostname do |machine|
      machine.vm.box = options[:box]
      machine.vm.hostname = hostname
      machine.vm.network "private_network", type: "dhcp"
      machine.vm.provision :salt, install_master: options[:master]
    end
  end
end
This magically worked, or so I thought, until many failed attempts at
automatically settings up DNS resolution for the machine&rsquo;s friendly names. I
noticed that the hostnames of my machines were sometimes all huron or all
michigan or something other than master, even though the name of the
machine on the Vagrant side was correct. Then it dawned on me: it&rsquo;s using
whatever the last value of options in the loop was!'><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Why are Ruby blocks constructed like this?</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href=/ class=[]>Home
</a><a href=/blog/ class=[]>Blog
</a><a href=/glob/ class=[]>Glob
</a><a href=/projects/ class=[]>Projects
</a><a href=/about/ class=push-right>About</a></nav><main role=main><article id=content><header><section class=header-line><h1>Why are Ruby blocks constructed like this?</h1></section><section class=subheader-line><p class=subtitle>There is an obvious choice here, and it&rsquo;s not this one</p><ul id=article-tags><li><a href=/tags/programming>Programming</a></li><li><a href=/tags/ruby>Ruby</a></li><li><a href=/tags/vagrant>Vagrant</a></li><li><a href=/tags/devops>DevOps</a></li></ul></section></header><p>I took up a position with a new company that involves the use of SaltStack.
Since I&rsquo;d never used it before, I decided to try my hand at setting up a proof
of concept, and for that I wanted to use multiple machines. So I decided to use
Vagrant, another tool I&rsquo;m not familiar with, to declaratively spin up a few
VMs.</p><p>This is what I first tried:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>machines <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>master</span>:   { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>true</span>  },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>superior</span>: { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>michigan</span>: { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>ontario</span>:  { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>erie</span>:     { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>false</span> },
</span></span><span style=display:flex><span>  <span style=color:#e6db74>huron</span>:    { <span style=color:#e6db74>box</span>: <span style=color:#e6db74>&#34;bento/ubuntu-22.04&#34;</span>, <span style=color:#e6db74>master</span>: <span style=color:#66d9ef>false</span> }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#e6db74>&#34;2&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> hostname, options <span style=color:#66d9ef>in</span> machines
</span></span><span style=display:flex><span>    config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>define hostname <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>machine<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>      machine<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> options<span style=color:#f92672>[</span><span style=color:#e6db74>:box</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>      machine<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>hostname <span style=color:#f92672>=</span> hostname
</span></span><span style=display:flex><span>      machine<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>network <span style=color:#e6db74>&#34;private_network&#34;</span>, <span style=color:#e6db74>type</span>: <span style=color:#e6db74>&#34;dhcp&#34;</span>
</span></span><span style=display:flex><span>      machine<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>provision <span style=color:#e6db74>:salt</span>, <span style=color:#e6db74>install_master</span>: options<span style=color:#f92672>[</span><span style=color:#e6db74>:master</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This magically worked, or so I thought, until many failed attempts at
automatically settings up DNS resolution for the machine&rsquo;s friendly names. I
noticed that the hostnames of my machines were sometimes all <code>huron</code> or all
<code>michigan</code> or something other than <code>master</code>, even though the name of the
machine on the Vagrant side was correct. Then it dawned on me: <em>it&rsquo;s using
whatever the last value of <code>options</code> in the loop was!</em></p><p>This will become clearer with the simple examples I wrote to verify that this
was indeed what was happening. We&rsquo;ll start with a naive example that actually
works as expected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>simply_yield</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>yield</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>simply_yield <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    simply_yield <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>      puts i
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>This prints the numbers 1 through 10, as expected, and not 10 ten times. This
makes sense, following the line of execution, assuming blocks are immediately
executed after the method to which they were passed, which they are in this
case. So it must be that the blocks passed to <code>config.vm.define</code> in Vagrant are
not!</p><p>That makes sense, as provisioners can be executed separately from bringing the
machines up. It stands to reason that the block themselves, as closures, are
stored in state somewhere, so they can then be invoked. Let&rsquo;s write an example
that does exactly that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>$functions <span style=color:#f92672>=</span> <span style=color:#f92672>[]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>store_for_later</span>(<span style=color:#f92672>&amp;</span>block)
</span></span><span style=display:flex><span>  $functions <span style=color:#f92672>&lt;&lt;</span> block
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#66d9ef>in</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  store_for_later <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    puts i
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$functions<span style=color:#f92672>.</span>each <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>f<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  f<span style=color:#f92672>.</span>call
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><p>If you run this, you&rsquo;ll see that it prints 10 ten times. <em>We&rsquo;ve found the
problem!</em> In other words, the <code>i</code> in the block / closure that was stored for
future use is a reference to the loop variable being updated. This is weird,
because in theory the loop variable should be scoped to the loop block and die
when the loop ends.</p><p>Adding a <code>puts i</code> after the loop to verify just in case shows that it is still
accessible. Maybe Ruby suffers from the same problem as Python 2, where
variables in list comprehensions and loops leak into the outer scope.</p><p>Curious to see if Python 3 would be better behaved, I wrote the following bit
of code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>functions <span style=color:#f92672>=</span> [(<span style=color:#66d9ef>lambda</span>: i) <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>10</span>)]
</span></span><span style=display:flex><span><span style=color:#75715e># print(i) here yields a NameError, as expected</span>
</span></span><span style=display:flex><span>print([f() <span style=color:#66d9ef>for</span> f <span style=color:#f92672>in</span> functions])
</span></span></code></pre></div><p>This prints <code>[9, 9, 9, 9, 9, 9, 9, 9, 9, 9]</code>, which is not what I expected.
Other ways of defining the functions, such as using <code>def</code>, resulted in the same
problem. <strong>Python suffers from the same problem!</strong></p><p>So I guess we should just use sane languages where state isn&rsquo;t a problem. Like
Haskell! The following <em>just works.</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>functions</span> <span style=color:#f92672>::</span> [<span style=color:#66d9ef>Int</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>Int</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>functions</span> <span style=color:#f92672>=</span> [const i <span style=color:#f92672>|</span> i <span style=color:#f92672>&lt;-</span> [<span style=color:#ae81ff>1</span><span style=color:#f92672>..</span><span style=color:#ae81ff>10</span>]]
</span></span><span style=display:flex><span><span style=color:#75715e>-- can also be defined as map const [1..10]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>main</span> <span style=color:#f92672>::</span> <span style=color:#66d9ef>IO</span> ()
</span></span><span style=display:flex><span><span style=color:#a6e22e>main</span> <span style=color:#f92672>=</span> mapM_ (print <span style=color:#f92672>.</span> (<span style=color:#f92672>$</span> <span style=color:#ae81ff>0</span>)) functions
</span></span></code></pre></div></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/39080978515a213ce538c73488aee2b1c1343503><span class=commit-hash>3908097</span><span class=commit-subject>content(blog): add post on ruby blocks in vagrant</span></a></p><p id=timestamp>Updated November 2, 2023</p></footer></body></html>