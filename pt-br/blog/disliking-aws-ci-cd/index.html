<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="O objetivo original deste artigo era documentar as minhas aventuras usando a
su√≠te de servi√ßos de CI/CD oferecidas pela AWS. No entanto, conforme eu
encontrava empecilhos durante a implementa√ß√£o, ele foi se transformando em uma
esp√©cie de desabafo sobre o qu√£o imaturos eles s√£o. Muito do que havia sido
escrito at√© eu decidir desistir da prova de conceito foi mantido como estava.
O restante foi adaptado para o que voc√™ est√° prestes a ler."><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Descobri que desgosto da stack de CI/CD da AWS</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href class=[]>√çndice
</a><a href=/pt-br/blog/ class=[]>Blog</a></nav><main role=main><article id=content><header><section class=header-line><h1>Descobri que desgosto da stack de CI/CD da AWS</h1><aside id=translations><ul id=translations><li><a href=/blog/disliking-aws-ci-cd/ title=English><span role=img aria-label="United States flag">üá∫üá∏</span></a></li></ul></aside></section><section class=subheader-line><p class=subtitle>Tentativas frustradas de usar AWS CodeCommit, CodeBuild, e CodePipeline</p><ul id=article-tags><li><a href=/pt-br/tags/devops>DevOps</a></li><li><a href=/pt-br/tags/tecnologia>Tecnologia</a></li><li><a href=/pt-br/tags/ci/cd>CI/CD</a></li></ul></section></header><input type=checkbox id=toc-toggle-box>
<label for=toc-toggle-box id=toc-toggle><em>‚Ä¢ Table of Contents ‚Ä¢</em></label><nav id=TableOfContents><ul><li><a href=#o-pre√ßo-de-seguir-os-meus-passos>O pre√ßo de seguir os meus passos</a></li><li><a href=#considera√ß√µes-iniciais-e-sinais-vermelhos>Considera√ß√µes iniciais e sinais vermelhos</a></li><li><a href=#configurando-um-usu√°rio-para-o-aws-codecommit>Configurando um usu√°rio para o AWS CodeCommit</a></li><li><a href=#compilando-minha-configura√ß√£o-do-xmonad-na-aws>Compilando minha configura√ß√£o do XMonad na AWS</a><ul><li><a href=#enviando-commits-ao-aws-codecommit>Enviando commits ao AWS CodeCommit</a></li><li><a href=#abrindo-uma-pull-request>Abrindo uma pull request</a></li><li><a href=#criando-uma-pipeline-de-ci>Criando uma pipeline de CI</a><ul><li><a href=#usando-codepipeline-do-jeito-errado>Usando CodePipeline do jeito errado</a></li><li><a href=#usando-o-codebuild-sozinho>Usando o CodeBuild sozinho</a></li><li><a href=#escrevendo-um-buildspecyml>Escrevendo um buildspec.yml</a></li></ul></li><li><a href=#executando-builds-para-toda-pull-request>Executando builds para toda pull request</a></li><li><a href=#obtendo-aprova√ß√£o-do-codebuild>Obtendo aprova√ß√£o do CodeBuild</a></li></ul></li><li><a href=#por-que-n√£o-recomendo-esses-servi√ßos>Por que n√£o recomendo esses servi√ßos</a></li><li><a href=#palavras-finais>Palavras finais</a></li></ul></nav><p>O objetivo original deste artigo era documentar as minhas aventuras usando a
su√≠te de servi√ßos de CI/CD oferecidas pela AWS. No entanto, conforme eu
encontrava empecilhos durante a implementa√ß√£o, ele foi se transformando em uma
esp√©cie de desabafo sobre o qu√£o imaturos eles s√£o. Muito do que havia sido
escrito at√© eu decidir <em>desistir da prova de conceito</em> foi mantido como estava.
O restante foi adaptado para o que voc√™ est√° prestes a ler.</p><p>H√° pouco tempo eu fiz um simulado do exame para a certifica√ß√£o <em>AWS Certified
DevOps Engineer Professional,</em> feito pela pr√≥pria AWS. As perguntas se
mostraram desafiadoras, provavelmente devido √† minha experi√™ncia pr√°tica com a
AWS at√© poucos meses atr√°s se resumir √† manuten√ß√£o de inst√¢ncias EC2 e clusters
EKS/ECS, enquanto as perguntas do exame abordavam bastante os servi√ßos de CI/CD
que a AWS oferece. <strong>No fim, s√≥ 50% das minhas respostas estavam corretas.</strong></p><p>Como forma de estudar e compensar a falta de experi√™ncia, decidi experimentar
com o <em>AWS CodeCommit, CodeBuild</em> e <em>CodePipeline</em> por conta pr√≥pria ao ver
como seria us√°-los em alguns dos meus projetos pessoais. <em>Meu plano inicial</em>
era escolher alguns projetos pessoais com requisitos diferentes, reproduzi-los
usando os servi√ßos mencionados, e ent√£o escrever sobre minha experi√™ncia e
fazer uma compara√ß√£o superficial entre usar exclusivamente a AWS e
exclusivamente o GitHub ou GitLab e seus servi√ßos integrados. <strong>Minha
conclus√£o: mantenha-se nestes se puder.</strong></p><h2 id=o-pre√ßo-de-seguir-os-meus-passos>O pre√ßo de seguir os meus passos</h2><p>Neste momento em que vos escrevo, todos os servi√ßos mencionados oferecem um
<em>free tier</em> suficiente para que voc√™ possa experiment√°-los pelo menos uma vez.
Contudo, <em>este artigo n√£o √© um guia,</em> e se voc√™ seguir todos os passos aqui
descritos √† risca, s√≥ vai acabar perdendo tempo e ficando frustrado, pois
<strong>tamb√©m abordarei meus erros.</strong> Caso voc√™ possa usar o <em>free tier</em> e realmente
deseja experimentar estes servi√ßos, tudo o que posso dizer √© que n√£o tive
nenhum custo associado ao que aqui est√° documentado.</p><p>Um pouco da minha frustra√ß√£o pode ser atribu√≠da ao fato de eu <em>insistir em usar
o Terraform</em> sem recorrer a m√≥dulos de terceiros. Se voc√™ n√£o se importa em
usar o console da AWS, recomendo que o fa√ßa a menos que voc√™ j√° esteja
familiarizado com ambos AWS e Terraform.</p><h2 id=considera√ß√µes-iniciais-e-sinais-vermelhos>Considera√ß√µes iniciais e sinais vermelhos</h2><p>A AWS √© uma plataforma com uma tonelada de servi√ßos diferentes, e n√£o uma su√≠te
de Git. Implementar uma su√≠te de Git do zero n√£o √© uma tarefa f√°cil, mas a AWS
fez o seu trabalho ficar ainda mais dif√≠cil ao decidir integrar seus novos
produtos com os servi√ßos j√° existentes. Botando tudo no papel, eles fizeram um
trabalho impressionante, mas a sua experi√™ncia (de usu√°rio) n√£o ser√° t√£o suave
quanto seria no GitHub ou GitLab.</p><p>A seguir est√£o algumas observa√ß√µes que podem ser consideradas positivas,
negativas, ou neutras, a depender do seu ponto de vista:</p><ul><li><em>Usu√°rios do AWS CodeCommit s√£o usu√°rios IAM.</em> Ao contr√°rio do GitHub e
GitLab, todas as contas pertencem √† mesma conta: a sua conta da AWS. As
permiss√µes s√£o gerenciadas atrav√©s de pol√≠ticas IAM, e chaves SSH s√£o
adicionadas atrav√©s do console do IAM.</li><li><em>Chaves SSH usadas no AWS CodeCommit n√£o podem ser do tipo ED25519,</em> apesar
de inst√¢ncias EC2 darem suporte √† cifra de curva el√≠ptica. Chaves SSH
p√∫blicas precisam ser do tipo RSA ou PEM para serem usadas com o servi√ßo, o
que exclui chaves ED25519.</li><li><em>O nome de usu√°rio para SSH n√£o √© <code>'git'</code>, mas sim um ID de chave aleat√≥rio,</em>
gerado ap√≥s voc√™ adicionar a chave √† sua conta IAM. A alternativa seria
restringir chaves a uma √∫nica conta, j√° que a chave serviria como identidade.</li><li><em>Reposit√≥rios s√£o criados em regi√µes espec√≠ficas,</em> em vez de existirem
globalmente. Isso √© evidenciado na URL usada para clonar o reposit√≥rio, e
pode ter sido feito por quest√µes de conformidade legal.</li><li><em>O CodeBuild e o CodePipeline contam como usu√°rios do CodeCommit,</em> j√° que
assumem uma identidade na AWS ao acessarem reposit√≥rios, e portanto se
encaixam na defini√ß√£o de usu√°rio ativo. J√° mencionei que voc√™ precisa
gerenciar estas permiss√µes?</li><li><em>Voc√™ n√£o pode s√≥ adicionar um arquivo para rodar builds automaticamente,</em>
voc√™ vai ter que usar o EventBridge para capturar eventos do CodeCommit e,
dependendo do que voc√™ quer fazer, fun√ß√µes Lambda podem ser sua √∫nica op√ß√£o.</li><li><em>Pipelines do CodePipeline operam em um branch fixo,</em> o que significa que voc√™
pode acabar criando pipelines quase id√™nticas dependendo do seu fluxo de
trabalho. Nem o Jenkins √© t√£o inflex√≠vel nesse ponto.</li></ul><p>Eu n√£o tinha conhecimento de nada disso quando embarquei nessa jornada. Estes
foram apenas os primeiros sinais de que eu n√£o teria uma boa experi√™ncia. Pelo
menos n√£o se eu j√° tivesse usado GitHub Actions, GitLab CI/CD ou Jenkins antes.
<strong>Estas ferramentas t√™m suas pr√≥prias falhas e limita√ß√µes,</strong> e algumas n√£o s√£o
pequenas, mas para a maioria dos casos de uso, eu ainda escolheria qualquer
delas em vez dos servi√ßos da AWS.</p><h2 id=configurando-um-usu√°rio-para-o-aws-codecommit>Configurando um usu√°rio para o AWS CodeCommit</h2><p>Como j√° mencionado, <em>usu√°rios do CodeCommit s√£o usu√°rios IAM,</em> ent√£o a primeira
coisa a ser feita √© criar um usu√°rio que tenha acesso ao servi√ßo, ou conceder
tal acesso a um usu√°rio existente, que foi o que eu fiz. Aqui vai um aviso
antes de voc√™ criar um monte de usu√°rios para um cen√°rio hipot√©tico: o <em>free
tier</em> do CodeCommit permite at√© 5 usu√°rios ativos, definidos da seguinte forma:</p><blockquote><p>Um usu√°rio ativo √© uma identidade AWS (usu√°rio/role IAM, usu√°rio federado, ou
conta root) √∫nico, que acessa reposit√≥rios do AWS CodeCommit durante o m√™s,
seja atrav√©s de requisi√ß√µes Git ou usando o console de gerenciamento da AWS.
Um servidor acessando o CodeCommit usando uma identidade AWS √∫nica conta como
um usu√°rio ativo.</p></blockquote><p>Ent√£o n√£o h√° raz√£o para se preocupar tendo menos de 5 usu√°rios ativos segundo a
defini√ß√£o acima. Para evitar lidar com pol√≠ticas inline, eu <em>criei um grupo
chamado CodeTools,</em> ao qual adicionei a pol√≠tica <em>AWSCodeCommitPowerUser,</em> que
d√° acesso total ao CodeCommit, com exce√ß√£o da permiss√£o para deletar
reposit√≥rios. Mais pol√≠ticas pr√©-definidas podem ser adicionadas ao grupo
conforme necess√°rio.</p><p>O pr√≥ximo passo √© ir ao console do IAM e adicionar uma <em>chave p√∫blica SSH para
AWS CodeCommit</em> ao usu√°rio IAM que ser√° usado. Note que a chave <strong>deve ser do
tipo RSA ou estar no formato PEM.</strong> N√£o era o meu caso inicialmente, ent√£o
apenas gerei uma nova chave RSA:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ssh-keygen -t rsa  <span style=color:#75715e># a pubkey gerada estar√° em ~/.ssh/id_rsa.pub</span>
</span></span></code></pre></div><p>Normalmente, ao se autenticar via SSH com qualquer su√≠te Git, voc√™ usaria <code>git</code>
como nome de usu√°rio e a chave em si serviria como sua identidade. No entanto,
para o CodeCommit voc√™ precisar√° usar o <em>ID da chave SSH</em> adicionada ao usu√°rio
IAM. Ele √© gerado quando voc√™ adiciona a chave atrav√©s do console. Consulte
<a href=https://docs.aws.amazon.com/codecommit/latest/userguide/setting-up-ssh-unixes.html#setting-up-ssh-unixes-keys>esta parte da documenta√ß√£o</a> para mais detalhes.</p><h2 id=compilando-minha-configura√ß√£o-do-xmonad-na-aws>Compilando minha configura√ß√£o do XMonad na AWS</h2><p>O reposit√≥rio que estou tentando hospedar na AWS √© o
<a href=https://github.com/d3adb5/dotfiles>d3adb5/dotfiles</a>, atualmente hospedado no GitHub e com uma
pipeline de CI configurada atrav√©s do GitHub Actions. Os requisitos para que
este experimento seja considerado um sucesso s√£o:</p><ul><li>O reposit√≥rio √© hospedado no AWS CodeCommit.</li><li>Quando uma pull request for criada ou atualizada, a AWS rodar√° a pipeline de
CI.</li><li>A pipeline de CI deve ser capaz de restaurar depend√™ncias entre builds por
meio de cache.</li></ul><p>O seguinte c√≥digo em Terraform foi usado para provisionar o reposit√≥rio:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_codecommit_repository&#34; &#34;dotfiles&#34;</span> {
</span></span><span style=display:flex><span>  repository_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dotfiles&#34;</span>
</span></span><span style=display:flex><span>  description     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Configuration files for the set of programs I use daily.&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;clone_url_ssh&#34;</span> {
</span></span><span style=display:flex><span>  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;URL used to clone the repository using SSH.&#34;</span>
</span></span><span style=display:flex><span>  value       <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_codecommit_repository</span>.<span style=color:#66d9ef>dotfiles</span>.<span style=color:#66d9ef>clone_url_ssh</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Como o reposit√≥rio foi criado na regi√£o <code>us-west-2</code>, os URLs para clon√°-lo
usar√£o o dom√≠nio <em>git-codecommit.us-west-2.amazonaws.com.</em></p><h3 id=enviando-commits-ao-aws-codecommit>Enviando commits ao AWS CodeCommit</h3><p>Eu gosto de usar nomes curtos e convenientes para hosts SSH em vez de URLs
inteiros, ent√£o adicionei o seguinte ao meu <code>~/.ssh/config</code>:</p><pre tabindex=0><code class=language-ssh-config data-lang=ssh-config>Host aws
  Hostname git-codecommit.us-west-2.amazonaws.com
  User IDDAMINHACHAVESSH
</code></pre><p>Em seguida, configurei o reposit√≥rio remoto e enviei o branch <code>master</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git remote add aws aws:/v1/repos/dotfiles
</span></span><span style=display:flex><span>git push aws master
</span></span></code></pre></div><p>E voil√†! N√≥s agora podemos ver o reposit√≥rio no console do CodeCommit:</p><figure><a href=/media/aws-codecommit-dotfiles-1.webp><img src=/media/aws-codecommit-dotfiles-1.webp alt="AWS CodeCommit mostrando os arquivos no branch principal."></a></figure><p>Sim, eu tentei fazer <em>push</em> para <code>git@git-codecommit.us-west-2.amazonaws.com</code>
no come√ßo. Pe√ßo-lhe um desconto, estou aprendendo as coisas da maneira dif√≠cil
em vez de seguir um tutorial, curso, ou lendo p√°ginas de documenta√ß√£o antes de
mais nada.</p><h3 id=abrindo-uma-pull-request>Abrindo uma pull request</h3><p>J√° que o &ldquo;novo&rdquo; reposit√≥rio usar√° exclusivamente os servi√ßos da AWS, nossa
primeira pull request remover√° o workflow do GitHub Actions. Primeiro, criemos
um novo branch para nossas mudan√ßas e o enviemos para o CodeCommit ap√≥s
criarmos novos commits:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git switch -c aws/remove-github-directory
</span></span><span style=display:flex><span>git rm -r .github
</span></span><span style=display:flex><span>git commit
</span></span><span style=display:flex><span>git push aws
</span></span></code></pre></div><p>Eu esperava ver uma mensagem com um URL para abrir uma pull request, mas o
CodeCommit nem isso fez. GitHub e GitLab o fazem sem necessidade de quaisquer
partes extras, ent√£o fiquei um pouco decepcionado.</p><p>Abrir uma pull request √© trivial, se voc√™ quiser clicar no console do
CodeCommit, mas se, como eu, voc√™ prefere usar a linha de comando, √© poss√≠vel
faz√™-lo atrav√©s do AWS CLI. Ele n√£o consegue inferir nenhuma informa√ß√£o do
reposit√≥rio em que voc√™ est√°, como as ferramentas CLI oficiais do GitHub e
GitLab fazem, ent√£o voc√™ precisar√° fornecer, <em>no m√≠nimo,</em> um t√≠tulo, o nome do
reposit√≥rio e os branches de origem e base:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws codecommit create-pull-request <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --title <span style=color:#e6db74>&#34;Remove GitHub Actions workflow&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --targets repositoryName<span style=color:#f92672>=</span>dotfiles,sourceReference<span style=color:#f92672>=</span>aws/remove-github-directory,destinationReference<span style=color:#f92672>=</span>master
</span></span></code></pre></div><p>O comando acima assume que voc√™ configurou o AWS CLI para usar o usu√°rio IAM
configurado para o CodeCommit e para usar a regi√£o da AWS onde o reposit√≥rio
foi adicionado. Uma vers√£o completa do comando usaria a flag <code>--region</code> e
talvez <code>--profile</code> para se referir √†s credenciais apropriadas.</p><p>Espera-se algo assim o console da AWS se tudo ocorreu como esperado:</p><figure><a href=/media/aws-codecommit-dotfiles-2.webp><img src=/media/aws-codecommit-dotfiles-2.webp alt="√â assim que nossa pull request se mostra no console do CodeCommit."></a></figure><h3 id=criando-uma-pipeline-de-ci>Criando uma pipeline de CI</h3><p>Este √© o desafio verdadeiro. Com GitHub Actions, GitLab CI/CD e Bitbucket
Pipelines, tudo que voc√™ precisa fazer √© adicionar os arquivos certos com os
nomes certos ao reposit√≥rio e eles ser√£o automaticamente lidos pela su√≠te e
enviados para uma fila para serem consumidos pelos agentes de build. Vamos,
ent√£o, revisar o √∫nico job em nosso workflow atual do GitHub Actions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>XMonad</span>
</span></span><span style=display:flex><span><span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span><span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>haskell/actions/setup@v2</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>enable-stack</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stack-version</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>stack-no-global</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/cache@v3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>~/.stack</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>stack-global-${{ hashFiles(&#39;xmonad/stack.yaml&#39;) }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restore-keys</span>: <span style=color:#ae81ff>stack-global-</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/cache@v3</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>path</span>: <span style=color:#ae81ff>xmonad/.stack-work</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>key</span>: <span style=color:#ae81ff>stack-work-${{ hashFiles(&#39;xmonad/stack.yaml&#39;) }}-${{ hashFiles(&#39;**/*.hs&#39;) }}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restore-keys</span>: <span style=color:#ae81ff>stack-work-</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>sudo apt-get install -y libx11-dev libxft-dev libxinerama-dev libxrandr-dev libxss-dev</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>cd xmonad &amp;&amp; stack build</span>
</span></span></code></pre></div><p>Os nomes de steps e as linhas em branco foram removidas para encurtar o trecho
acima. O que o YAML acima nos diz √© que:</p><ol><li>Este job ser√° executado em um runner rodando a <em>√∫ltima vers√£o do Ubuntu.</em></li><li>N√≥s faremos <em>checkout</em> do reposit√≥rio atrav√©s de <code>actions/checkout</code>,</li><li>Configuraremos a toolchain de Haskell com a √∫ltima vers√£o do Stack,</li><li>Instalaremos as bibliotecas necess√°rias pelas depend√™ncias do XMonad, e</li><li>Entraremos no diret√≥rio do XMonad e construiremos o projeto.</li></ol><p>Adicionalmente, atrav√©s da action <code>actions/cache</code>, estamos dizendo ao GitHub
Actions que:</p><ul><li><em>Antes do passo 4,</em> tente restaurar as depend√™ncias e instala√ß√µes do GHC
armazenadas em cache.</li><li><em>Depois do passo 5,</em> armazene as depend√™ncias e instala√ß√µes do GHC em cache.</li></ul><p>Como podemos reproduzir o comportamento acima com as ferramentas <em>AWS Code*</em>?
Mais importante, de quais ferramentas n√≥s realmente precisamos?</p><h4 id=usando-codepipeline-do-jeito-errado>Usando CodePipeline do jeito errado</h4><p>A distin√ß√£o entre <em>CodePipeline</em> e <em>CodeBuild</em> n√£o estava imediatamente clara
para mim. Julgando pelo nome e por alguns artigos sobre pipelines de CI/CD na
AWS, assumi que o CodePipeline seria um produto de pipeline de automa√ß√£o geral
&mdash; algo parecido com o Jenkins &mdash; e que o CodeBuild seria usado pelo
CodePipeline para os stages de build. <em>Embora o √∫ltimo possa ser o caso √†s
vezes,</em> o CodeBuild pode ser usado por si s√≥ para integra√ß√£o cont√≠nua.</p><p>Sem saber disso, tentei criar e escrever uma pipeline. Para construir o c√≥digo,
√© necess√°rio um projeto CodeBuild, algo que pode ser criado automaticamente
pela AWS ao se criar uma pipeline atrav√©s do console. No entanto, aqui estamos
provisionando todo recurso via Terraform, ent√£o vamos come√ßar:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_codepipeline&#34;</span> <span style=color:#e6db74>&#34;dotfiles&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dotfiles-ci&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>role_arn</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>codepipeline</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stage</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>      # ...
</span></span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stage</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>      # ...
</span></span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A pipeline que estamos definindo precisa apenas de dois stages: fazer checkout,
construir o projeto. Ao contr√°rio dos stages arbitr√°rios de pipeline do Jenkins
que estamos acostumados a ver, a API do CodePipeline estipula que as actions
tenham um <em>ActionTypeId</em> especificando par√¢metros que ser√£o usados para impor
algumas restri√ß√µes sobre ela. Isso deve ficar mais claro √† medida que
continuamos nossa action de checkout:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CodeCommit&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>owner</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AWS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>configuration</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RepositoryName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codecommit_repository</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>repository_name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BranchName</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;master&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Parece bom o suficiente, certo? Talvez possamos <strong>especificar qual branch n√≥s
queremos construir</strong> quando iniciarmos uma pipeline. Isso <em>n√£o √© poss√≠vel</em> no
momento, raz√£o pela qual escolher o CodePipeline foi um erro. De qualquer
jeito, vamos para a action de build. Ela pode ser definida da seguinte maneira,
e podemos criar um <code>buildspec.yml</code> depois:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CodeBuild&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>owner</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AWS&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;1&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>configuration</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ProjectName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codebuild_project</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Precisamos de um projeto no CodeBuild, como voc√™ pode inferir lendo o trecho
acima. Felizmente, criar um projeto CodeBuild √© <em>trivial, mas cobriremos isso
depois,</em> quando tocarmos na solu√ß√£o de fato. As √∫nicas coisas que mudam do que
voc√™ ver√° nas se√ß√µes posteriores s√£o que a string <code>"CODEPIPELINE"</code> √© usada para
ambos os tipos de <code>source</code> e <code>artifacts</code> na declara√ß√£o do projeto.</p><p>N√£o t√£o felizmente, lidar com permiss√µes n√£o vai ser a √∫ltima coisa que voc√™
precisar√° fazer nesta declara√ß√£o, porque eu deixei de fora alguns argumentos
nos blocos de action acima. Acontece que a categoria n√£o √© suficiente para
dizer √† AWS que voc√™ quer seu c√≥digo fonte presente em est√°gios posteriores da
pipeline: <em>voc√™ precisa declarar artefatos de input e output</em> para suas
actions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Source&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>output_artifacts</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;source_output&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Build&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>  # ...
</span></span></span><span style=display:flex><span>  <span style=color:#a6e22e>input_artifacts</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;source_output&#34;</span>]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Essa no√ß√£o de artefatos de entrada e sa√≠da √© generalizada, no entanto, e n√£o se
aplica apenas a levar arquivos de um est√°gio para outro. Consequentemente, voc√™
precisar√° de um lugar para armazenar esses artefatos, pois <strong>o CodePipeline n√£o
far√° isso por voc√™.</strong> Somos for√ßados a declarar um bloco <code>artifact_store</code>, e
atualmente o CodePipeline suporta apenas S3.</p><p>Apesar de ter dito que n√£o usaria m√≥dulos de terceiros, abro aqui uma exce√ß√£o
para declara√ß√£o de um bucket S3, j√° que ningu√©m merece ter que replicar todo o
boilerplate que acompanha o <code>resource</code> do bucket:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;artifacts_bucket&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;terraform-aws-modules/s3-bucket/aws&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;3.8.2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>bucket</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;codepipeline-dotfiles-ci-artifacts&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>acl</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>block_public_acls</span>       <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>block_public_policy</span>     <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ignore_public_acls</span>      <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>restrict_public_buckets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>E ent√£o podemos adicionar o bloco <code>artifact_store</code> √† declara√ß√£o da pipeline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>artifact_store</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> module.<span style=color:#a6e22e>artifacts_bucket</span>.<span style=color:#a6e22e>s3_bucket_id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;S3&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Foi s√≥ quando tentei disparar a pipeline ao abrir ou atualizar pull requests
que descobri que voc√™ n√£o pode selecionar o branch que vai construir atrav√©s do
CodePipeline. Dei uma chance ao CodeBuild e percebi que <em>ele √© a ferramenta a
ser usada para integra√ß√£o cont√≠nua.</em></p><h4 id=usando-o-codebuild-sozinho>Usando o CodeBuild sozinho</h4><p>N√£o deu certo usar o CodePipeline. No lugar, vamos usar s√≥ o <em>CodeBuild,</em> j√°
que a sua API permite n√£o s√≥ especificar a refer√™ncia Git que ele vai buscar no
reposit√≥rio, mas tamb√©m especificar vari√°veis de ambiente! H√° duas coisas de
que precisamos para come√ßar: um projeto e uma especifica√ß√£o de build. Esta deve
ficar nos reposit√≥rio e portanto ser√° escrita mais abaixo.</p><p>Explicando de forma breve o CodeBuild: ele provisiona a infraestrutura
necess√°ria para seguir as instru√ß√µes de uma especifica√ß√£o de build. A
especifica√ß√£o de build pode vir de um arquivo <code>buildspec.yml</code> na raiz do c√≥digo
fonte que √© obtido quando voc√™ inicia um build atrav√©s deste servi√ßo. Em sua
ess√™ncia, √© bem parecido com um <em>workflow</em> do <em>GitHub Actions</em> no sentido de
que ele descreve os comandos a serem executados em um ambiente de build.</p><p>Como j√° dito anteriormente, voc√™ pode criar um projeto pelo console e ser
feliz. No entanto, <em>o jeito dif√≠cil √© sempre mais divertido,</em> ent√£o aqui est√° o
c√≥digo Terraform que usei para criar meu projeto, depois de desistir do
CodePipeline:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_codebuild_project&#34;</span> <span style=color:#e6db74>&#34;dotfiles&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dotfiles&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>service_role</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>codebuild</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span>     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CODECOMMIT&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>location</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codecommit_repository</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>clone_url_http</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>environment</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span>         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LINUX_CONTAINER&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>compute_type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;BUILD_GENERAL1_SMALL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>image</span>        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aws/codebuild/standard:7.0&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>logs_config</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cloudwatch_logs</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>group_name</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;/aws/codebuild/dotfiles&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>stream_name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dotfiles&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>artifacts</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;NO_ARTIFACTS&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Sim, √© simples assim! <strong>Para criar o projeto, quero dizer,</strong> repare que no
trecho de c√≥digo acima estamos nos referindo a um certo recurso
<code>aws_iam_role.codebuild</code>, mas eu n√£o mostrei o c√≥digo que o cria nem as
policies de que ele precisa! <em>Vamos primeiro analisar a configura√ß√£o acima:</em></p><ul><li>O projeto se chama <code>dotfiles</code> e se comunica com a AWS atrav√©s de uma certa
IAM role.</li><li>O c√≥digo fonte √© obtido do nosso reposit√≥rio no <em>AWS CodeCommit.</em></li><li>O build ser√° executado em um container Linux com <em>pouco</em> poder de
processamento.</li><li>O container usar√° a imagem <code>aws/codebuild/standard:7.0</code>, baseada em Ubuntu.</li><li>Logs ser√£o escritos no <em>CloudWatch Logs,</em> no grupo e stream dados.</li><li>N√£o h√° artefatos a serem produzidos por este build.</li></ul><p><a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/codebuild_project>Esta se√ß√£o</a> da documenta√ß√£o do provider AWS para
Terraform lhe dar√° muito mais detalhes do que posso fornecer aqui.</p><p>Algo que √© interessante apontar aqui √© que os recursos computacionais do
container onde o build ser√° executado s√£o definidos no lado do <em>CodeBuild</em> e
n√£o na especifica√ß√£o de build. <em>Isso significa que haver√° coisas fora do nosso
reposit√≥rio que afetam nosso build,</em> o que √© algo a se ter em mente quando se
busca por reprodutibilidade e GitOps.</p><h4 id=escrevendo-um-buildspecyml>Escrevendo um buildspec.yml</h4><p>H√° espa√ßo para melhorias aqui, incluindo usar uma imagem Docker que j√° conta
com a toolchain de Haskell e talvez at√© as depend√™ncias de que precisamos, mas
deixo isso para um momento futuro. Estamos criando uma prova de conceito, ent√£o
a otimiza√ß√£o de custo pode esperar.</p><p>Esse √© o <code>buildspec.yml</code> que escrevi para reproduzir o que hoje √© feito pelo
GitHub Actions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>phases</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>install</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>apt-get update -y</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>apt-get install -y libx11-dev libxft-dev libxinerama-dev libxrandr-dev libxss-dev</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>curl -sSL https://get.haskellstack.org/ | sh</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pre_build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>cd xmonad</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>stack build --only-dependencies</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>stack build</span>
</span></span></code></pre></div><p>Sinto dizer que adicionar o arquivo √† staging, criando a commit e a enviando
para o branch criado anteriormente neste artigo n√£o resulta em builds
autom√°ticos. Al√©m disso, observe os nomes das <em>phases</em> no arquivo. Esses nomes
n√£o s√£o arbitr√°rios, mas sim <a href=https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html#build-spec-ref-syntax>parte da sintaxe.</a></p><p>Com este arquivo presente no branch <code>aws/remove-github-directory</code>, iniciar um
build nesse branch nos leva a um sucesso:</p><figure><a href=/media/aws-codecommit-dotfiles-3.webp><img src=/media/aws-codecommit-dotfiles-3.webp alt="CodeBuild showing a list of successful build phases."></a></figure><p>J√° que conseguimos fazer um build com sucesso seguindo essa especifica√ß√£o,
<em>vamos fazer merge</em> do nosso branch, assim a <em>master</em> estar√° pronta para ser
constru√≠da a qualquer momento.</p><h3 id=executando-builds-para-toda-pull-request>Executando builds para toda pull request</h3><p>Na AWS, nada √© verdadeiramente simples. N√£o se voc√™ estiver evitando usar o
console para tudo que voc√™ faz, o que chamamos de <em>ClickOps.</em> Para fazer a
pipeline de CI executar em toda pull request, precisamos reagir a eventos do
<em>CodeCommit</em> atrav√©s do <em>EventBridge,</em> disparando um build do <em>CodeBuild.</em></p><p>Queremos que nossa regra seja acionada quando uma pull request √© criada
(<code>pullRequestCreated</code>) e quando o branch de origem (head) de uma pull request √©
atualizado (<code>pullRequestSourceBranchUpdated</code>). Seguindo isso, a regra pode ser
declarada da seguinte maneira:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudwatch_event_rule&#34;</span> <span style=color:#e6db74>&#34;pull_requests&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dotfiles-pull-requests&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Triggered when a pull request is created or updated.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>event_pattern</span> <span style=color:#f92672>=</span> jsonencode({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>detail</span><span style=color:#a6e22e>-type</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;CodeCommit Pull Request State Change&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resources</span>   <span style=color:#f92672>=</span> [<span style=color:#a6e22e>aws_codecommit_repository</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>arn</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>detail</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>event</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;pullRequestCreated&#34;</span>, <span style=color:#e6db74>&#34;pullRequestSourceBranchUpdated&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>O projeto do <em>CodeBuild</em> ser√° nosso target, e n√≥s precisaremos transformar o
input para que a commit certa seja constru√≠da, pois caso contr√°rio o
<em>CodeBuild</em> vai construir a √∫ltima vers√£o do c√≥digo por padr√£o, e n√≥s daremos
uma estrelinha de sucesso ou alerta de falha para as PRs erradas. O target √©
definido assim:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudwatch_event_target&#34;</span> <span style=color:#e6db74>&#34;codebuild&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rule</span>     <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_cloudwatch_event_rule</span>.<span style=color:#a6e22e>pull_requests</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>arn</span>      <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codebuild_project</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>role_arn</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>eventbridge_codebuild</span>.<span style=color:#a6e22e>arn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>input_transformer</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>input_paths</span>    <span style=color:#f92672>=</span> { <span style=color:#a6e22e>sourceCommit</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#e6db74>.detail.sourceCommit&#34;</span> }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>input_template</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;-ENDOFINPUT</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        &#34;sourceVersion&#34;: &#34;&lt;sourceCommit&gt;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    </span><span style=color:#f92672>ENDOFINPUT</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>O <em>heredoc</em> indentado acima √© usado em vez de <code>jsonencode()</code> porque este escapa
os sinais de menor e maior que que usamos para nos referir √† chave de entrada
<code>sourceCommit</code> &mdash; resultando no <em>CodeBuild</em> tentando buscar uma ref chamada
<code>&lt;sourceCommit></code>. <strong>Falo por experi√™ncia pr√≥pria.</strong></p><p>Da refer√™ncia ao recurso <em><code>aws_iam_role.eventbridge_codebuild.arn</code></em> voc√™ pode
ver que mais uma role precisa ser criada. Essa √© felizmente bem simples e
precisa apenas da permiss√£o <em><code>codebuild:StartBuild</code></em> para o projeto criado
alguns passos atr√°s.</p><p>Com regra e target provisionados, criei um novo branch fazendo uma mudan√ßa
pequena √† configura√ß√£o XMonad e criei uma pull request, o que <em>levou a um build
acontecendo automaticamente!</em> Um push subsequente confirmou que mudan√ßas feitas
√† PR tamb√©m acionam novos builds.</p><h3 id=obtendo-aprova√ß√£o-do-codebuild>Obtendo aprova√ß√£o do CodeBuild</h3><p>Agora temos um reposit√≥rio e uma pipeline. A pipeline roda toda vez que uma
pull request √© aberta ou atualizada, mas do jeito que as coisas est√£o, <em>pull
requests ainda podem ser mergeadas se a pipeline falhar!</em> Afinal, n√£o h√° uma
rela√ß√£o sem√¢ntica inerente entre o CodeBuild e pull requests no CodeCommit.
Al√©m disso, aprova√ß√µes no CodeCommit tamb√©m s√£o feitas de uma maneira pouco
usual. Permita-me explicar.</p><p>No CodeCommit, regras de aprova√ß√£o podem ser adicionadas a pull requests
individualmente. Isso mesmo, voc√™ pode criar uma regra de aprova√ß√£o para uma
pull request informando o n√∫mero de aprova√ß√µes necess√°rias e os grupos de
identidades AWS que podem conceder tais aprova√ß√µes. <strong>Voc√™ n√£o pode criar uma
regra para o reposit√≥rio!</strong> Pelo menos n√£o diretamente: voc√™ deve criar um
template de regra de aprova√ß√£o para o CodeCommit e associ√°-lo ao seu
reposit√≥rio.</p><p>Meu desejo √© que qualquer pull request que esteja falhando o check de
integra√ß√£o cont√≠nua n√£o possa ser mergeada, ent√£o criarei um template de regra
de aprova√ß√£o e o associarei ao reposit√≥rio <code>dotfiles</code>. Tal template requer
apenas uma aprova√ß√£o, que ser√° chamada de <code>built-approval</code>, que por sua vez
poder√° ser concedida por qualquer identidade que assuma a role que o
<em>CodeBuild</em> est√° usando:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_codecommit_approval_rule_template&#34;</span> <span style=color:#e6db74>&#34;ci&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;build-approval&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Approvals comings from CodeBuild.&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>content</span> <span style=color:#f92672>=</span> jsonencode({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Version</span>               <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2018-11-08&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DestinationReferences</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;refs/heads/master&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Statements</span> <span style=color:#f92672>=</span> [{
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Type</span>                    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Approvers&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>NumberOfApprovalsNeeded</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ApprovalPoolMembers</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>replace(<span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>codebuild</span>.<span style=color:#a6e22e>arn</span>, <span style=color:#e6db74>&#34;role&#34;</span>, <span style=color:#e6db74>&#34;assumed-role&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>/*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    }]
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_codecommit_approval_rule_template_association&#34;</span> <span style=color:#e6db74>&#34;ci&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repository_name</span>             <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codecommit_repository</span>.<span style=color:#a6e22e>dotfiles</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>approval_rule_template_name</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>aws_codecommit_approval_rule_template</span>.<span style=color:#a6e22e>ci</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Finalmente, precisamos da aprova√ß√£o do CodeBuild no caso de um build bem
sucedido, certo? Como eu disse, <strong>n√£o h√° rela√ß√µes sem√¢nticas inerentes entre
CodeBuild e CodeCommit.</strong> Os servi√ßos s√£o independentes um do outro, e n√£o h√°
integra√ß√µes para tornar mais f√°cil us√°-los juntos. Desde acionar builds at√©
prevenir merges quebrados, cabe ao usu√°rio se virar sozinho.</p><p>O CLI da AWS vem j√° instalado na imagem Ubuntu que escolhi para o projeto no
CodeBuild, ent√£o depois de dar uma lida <a href=https://docs.aws.amazon.com/codecommit/latest/APIReference/API_UpdatePullRequestApprovalState.html>na refer√™ncia de
API</a>, pensei que aprovar a pull request poderia ser
feito com um comando como:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws codecommit update-pull-request-approval-state <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --pull-request-id $PULL_REQUEST_ID <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --revision-id $REVISION_ID <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --approval-state APPROVE
</span></span></code></pre></div><p>E a√≠ eu s√≥ precisaria passar essas duas vari√°veis de ambiente a partir do
evento disparado pelo CodeCommit atualizando o bloco <code>input_transformer</code> na
declara√ß√£o do target do EventBridge assim:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>input_transformer</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>input_paths</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sourceCommit</span>  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#e6db74>.detail.sourceCommit&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pullRequestId</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#e6db74>.detail.pullRequestId&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>revisionId</span>    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#e6db74>.detail.revisionId&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>input_template</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;-ENDOFINPUT</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;sourceVersion&#34;: &#34;&lt;sourceCommit&gt;&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;environmentVariablesOverride&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        { &#34;name&#34;: &#34;PULL_REQUEST_ID&#34;, &#34;value&#34;: &#34;&lt;pullRequestId&gt;&#34; },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        { &#34;name&#34;: &#34;REVISION_ID&#34;,     &#34;value&#34;: &#34;&lt;revisionId&gt;&#34; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  </span><span style=color:#f92672>ENDOFINPUT</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Colocar o comando na especifica√ß√£o de build na fase de <em><code>post_build</code></em> levaria a
uma aprova√ß√£o sendo emitida toda vez, porque de acordo com a documenta√ß√£o, <a href=https://docs.aws.amazon.com/codebuild/latest/userguide/view-build-details.html#view-build-details-phases>a
fase de <em>post-build</em> √© executada independentemente do sucesso ou falha do
build.</a> Mais uma emenda se faz necess√°ria. Dessa vez, na
especifica√ß√£o de build:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span><span style=color:#f92672>commands</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>stack build</span>
</span></span><span style=display:flex><span><span style=color:#f92672>on-failure</span>: <span style=color:#ae81ff>ABORT </span> <span style=color:#75715e># Isso deve ser o suficiente!</span>
</span></span></code></pre></div><p>Uma vez certos de que a role do CodeBuild tem permiss√£o para atualizar o estado
de aprova√ß√£o de pull requests, abri uma pull request contendo uma mudan√ßa
trivial que n√£o quebraria nada e esperei por um build bem sucedido, seguido de
uma aprova√ß√£o na minha pull request. Os logs do build indicaram que tudo havia
ocorrido como esperado, com uma fase de <em>post-build</em> bem sucedida:</p><figure><a href=/media/aws-codecommit-dotfiles-4.webp><img src=/media/aws-codecommit-dotfiles-4.webp alt="Logs mostrando um build bem sucedido e o comando de approval."></a></figure><p>E de fato apareceu uma aprova√ß√£o na minha pull request, s√≥ n√£o encaixada na
regra como era de se esperar:</p><figure><a href=/media/aws-codecommit-dotfiles-5.webp><img src=/media/aws-codecommit-dotfiles-5.webp alt="Aprova√ß√£o do CodeBuild em uma pull request."></a></figure><p><em>Por qu√™?</em> Porque o usu√°rio que concedeu a aprova√ß√£o n√£o estava na pool de
identidades AWS definida no template da regra. Descobri isso ao obter a lista
de aprova√ß√µes via CLI da AWS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws codecommit get-pull-request-approval-states <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>    --pull-request-id <span style=color:#ae81ff>3</span> --revision-id the-revision-found-on-codebuild
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;approvals&#34;</span>: <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;userArn&#34;</span>: <span style=color:#e6db74>&#34;arn:aws:sts::...:assumed-role/CodeBuildDotfilesRole/...&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;approvalState&#34;</span>: <span style=color:#e6db74>&#34;APPROVE&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>O state do Terraform mostrava que os membros da pool de identidades do template
eram identificados via <em><code>arn:aws:iam:...</code></em> e portanto usavam um prefixo IAM em
vez de um STS. Atualizei a declara√ß√£o do template e pensei que talvez isso
consertaria tudo automaticamente:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#a6e22e>ApprovalPoolMembers</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>replace(replace(<span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>codebuild</span>.<span style=color:#a6e22e>arn</span>, <span style=color:#e6db74>&#34;role&#34;</span>, <span style=color:#e6db74>&#34;assumed-role&#34;</span>), <span style=color:#e6db74>&#34;iam&#34;</span>, <span style=color:#e6db74>&#34;sts&#34;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>/*&#34;</span>
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>Ficu bem feio, mas deve funcionar. <em>S√≥ que isso n√£o atualizou a regra de
aprova√ß√£o!</em> Acontece que o template da regra √© avaliado apenas quando a pull
request √© criada e nunca mais. Ent√£o criei uma nova pull request e esperei por
outro build para descobrir que o experimento foi um sucesso:</p><figure><a href=/media/aws-codecommit-dotfiles-7.webp><img src=/media/aws-codecommit-dotfiles-6.webp alt="Aprova√ß√£o do CodeBuild em uma pull request."></a></figure><p>E agora? Foi nesse momento, com apenas um item restante na nossa checklist, que
decidi desistir de vez.</p><h2 id=por-que-n√£o-recomendo-esses-servi√ßos>Por que n√£o recomendo esses servi√ßos</h2><p>A raz√£o pela qual desisti de terminar esse experimento tem menos a ver com as
limita√ß√µes desses servi√ßos da AWS e mais a ver com o fato de que n√£o sinto uma
press√£o para us√°-los no mercado atualmente. S√£o ferramentas ainda imaturas, com
funcionalidades limitadas e com idiossincrasias que s√≥ podemos chamar de
falhas. Essas palavras podem muito bem descrever algumas ferramentas usadas
diariamente na ind√∫stria de TI, mas n√£o vejo por que essas em particular o
deveriam ser.</p><p>√Äs startups, empresas estabelecidas e indiv√≠duos, esses servi√ßos provavelmente
oferecer√£o menos valor do que encontrar√£o em outro lugar. Aqui est√° uma tabela
comparando apenas alguns aspectos das ferramentas da AWS supracitadas com sua
competi√ß√£o para mostrar o porqu√™:</p><table class=compare-table><thead><th></th><th>AWS</th><th>GitHub</th><th>GitLab</th></thead><tbody><tr><td>Local √∫nico para todos seus grupos e reposit√≥rios</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>CLI dedicado para opera√ß√µes de Git di√°rias</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Habilidade de usar runners pr√≥prios nos builds</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>CI e CD s√£o definidos no mesmo formato e lugar</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Gerencia permiss√µes dos runners automaticamente</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Pode-se configurar builds de CI/CD com puro Git</td><td>‚ùå</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Builds de CI falhos proibem que PRs sejam mergeadas</td><td>DIY</td><td>3 clicks</td><td>‚úÖ</td></tr><tr><td>Reporta o status do build para a p√°gina da PR</td><td>DIY</td><td>‚úÖ</td><td>‚úÖ</td></tr><tr><td>Builds de CI podem ser usadas para fazer auto-merge</td><td>DIY</td><td>‚úÖ</td><td>‚úÖ</td></tr></tbody></table><p>Acredite, <em>n√£o estou querendo insultar a AWS.</em> H√° oportunidade para acomodar
muitos fluxos de trabalho elaborados, complicados e √∫nicos, especialmente se
voc√™ j√° usa a AWS para a infraestrutura que suporta suas aplica√ß√µes &mdash; voc√™
n√£o estaria usando esses servi√ßos se todos os seus workloads estivessem em
outro lugar &mdash;, mas eu simplesmente n√£o consigo superar o quanto de
configura√ß√£o √© necess√°ria apenas para disparar um build ao abrir uma pull
request.</p><p>Voc√™ n√£o precisa usar todas as ofertas da AWS juntas: voc√™ pode hospedar seu
reposit√≥rio no GitHub ou GitLab enquanto usa o CodeBuild para seus builds de
CI, ou at√© mesmo usar outros servi√ßos n√£o cobertos aqui, como o <em>CodeDeploy.</em>
Na verdade, minha cr√≠tica aqui √© principalmente direcionada ao CodeCommit,
CodeBuild e CodePipeline.</p><h2 id=palavras-finais>Palavras finais</h2><p>Eu levei 2 semanas para terminar de escrever esse artigo. N√£o √© porque mexer
com a AWS ou Terraform √© dif√≠cil, eu s√≥ fiquei ocupado e toda vez que eu
lembrava que teria que voltar a escrever boilerplate, eu ia adiando. Espero que
o que escrevi aqui tenha sido √∫til ou divertido para voc√™. Em algum momento
futuro pretendo experimentar o <em>CodeDeploy</em> e talvez escreva sobre ele tamb√©m.</p><p>E se voc√™ √© um dos engenheiros da AWS que trabalhou nessas ferramentas, por
favor n√£o leve minhas cr√≠ticas para o lado pessoal. Tenho certeza de que voc√™s
se orgulham do que constru√≠ram, e devem! Leve minhas palavras como as de um
cliente que gostaria de ver algumas funcionalidades a mais. N√£o sei por que
voc√™ estaria lendo meu blog, mas se estiver, voc√™s t√™m vagas abertas?
Brincadeira. A n√£o ser que&mldr;</p></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/b4e90215669e2c85ca075aa9b82ab7ac5bbf3ccb><span class=commit-hash>b4e9021</span><span class=commit-subject>content(blog): translate aws ci/cd article to pt-br</span></a></p><p id=timestamp>Updated May 22, 2023</p></footer></body></html>