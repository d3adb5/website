<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AVISO: Apesar da falta relativa de detalhes, esse artigo acabou t√£o extenso
que fui obrigado a incluir uma tabela de conte√∫do. Espero que n√£o seja uma
leitura cansativa, e que quem estiver lendo consiga pular para um t√≥pico de seu
interesse.
O prop√≥sito desta postagem √© dar ao leitor um resumo de como foi, para mim, se
acostumar com e implementar solu√ß√µes de integra√ß√£o cont√≠nua (CI) e deployment
cont√≠nuo (CD) em meus projetos pessoais. Foi e ainda est√° sendo como uma
rodovia esburacada, mas √© mais gratificante do que achei que seria quando
comecei."><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Experi√™ncias com CI/CD e DevOps</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href class=[]>√çndice
</a><a href=/pt-br/blog/ class=[]>Blog</a></nav><main role=main><article id=content><header><section class=header-line><h1>Experi√™ncias com CI/CD e DevOps</h1><aside id=translations><ul id=translations><li><a href=/blog/experiences-with-ci-cd/ title=English><span role=img aria-label="United States flag">üá∫üá∏</span></a></li></ul></aside></section><section class=subheader-line><p class=subtitle>Praticando DevOps com papel e caneta</p><ul id=article-tags><li><a href=/pt-br/tags/devops>DevOps</a></li><li><a href=/pt-br/tags/ci/cd>CI/CD</a></li><li><a href=/pt-br/tags/tecnologia>Tecnologia</a></li></ul></section></header><input type=checkbox id=toc-toggle-box>
<label for=toc-toggle-box id=toc-toggle><em>‚Ä¢ Table of Contents ‚Ä¢</em></label><nav id=TableOfContents><ul><li><a href=#engatinhando-git-hooks--gnu-make>Engatinhando: Git hooks & GNU Make</a><ul><li><a href=#por-que-n√£o-houve-integra√ß√£o-cont√≠nua>Por que n√£o houve Integra√ß√£o Cont√≠nua</a></li><li><a href=#por-que-houve-deployment-cont√≠nuo-talvez>Por que houve Deployment Cont√≠nuo (talvez)</a></li></ul></li><li><a href=#o-caminho-para-cicd-propriamente-dito>O caminho para CI/CD propriamente dito</a><ul><li><a href=#o-motivo-de-eu-nem-sempre-querer-usar-jenkins>O motivo de eu nem sempre querer usar Jenkins</a></li><li><a href=#github-actions-poupa-tempo-e-dinheiro>GitHub Actions poupa tempo e dinheiro</a></li><li><a href=#escolhendo-projeto-ferramentas-e-fluxo-de-trabalho>Escolhendo projeto, ferramentas, e fluxo de trabalho</a></li></ul></li><li><a href=#aprendendo-ansible>Aprendendo Ansible</a><ul><li><a href=#m√≥dulos-s√£o-uma-barreira-de-entrada-de-certa-maneira>M√≥dulos s√£o uma barreira de entrada, de certa maneira</a></li><li><a href=#como-foi-por-em-pr√°tica>Como foi por em pr√°tica</a></li></ul></li><li><a href=#gitops-o-que-√©-e-por-qu√™>GitOps, o que √© e por qu√™</a><ul><li><a href=#como-eu-acho-que-o-alcancei-no-meu-setup>Como eu acho que o alcancei no meu setup</a></li></ul></li></ul></nav><p><strong>AVISO:</strong> Apesar da falta relativa de detalhes, esse artigo acabou t√£o extenso
que fui obrigado a incluir uma tabela de conte√∫do. Espero que n√£o seja uma
leitura cansativa, e que quem estiver lendo consiga pular para um t√≥pico de seu
interesse.</p><p>O prop√≥sito desta postagem √© dar ao leitor um resumo de como foi, para mim, se
acostumar com e implementar solu√ß√µes de <em>integra√ß√£o cont√≠nua (CI)</em> e <em>deployment
cont√≠nuo (CD)</em> em meus projetos pessoais. Foi e ainda est√° sendo como uma
rodovia esburacada, mas √© mais gratificante do que achei que seria quando
comecei.</p><p>Minha atitude para com servi√ßos, programas e plataformas de CI/CD era de que
&ldquo;n√£o s√£o pra mim&rdquo;, e algo de que s√≥ projetos grandes ou empresas, liderados por
uma for√ßa-tarefa altamente qualificada, precisariam e tirariam proveito.</p><p>Tal posi√ß√£o com certeza mudou quando, trabalhando diretamente com o ciclo de
desenvolvimento de software e melhorando-o, tomei consci√™ncia do seu valor e
sentido. Agora eu sinto grande vontade de trazer testes automatizados, revis√µes
de c√≥digo, pull requests constantes, e deployment autom√°tico para todos os meus
projetos pessoais. √â um √≥timo jeito de definir e garantir um padr√£o de
qualidade.</p><h2 id=engatinhando-git-hooks--gnu-make>Engatinhando: Git hooks & GNU Make</h2><p>A primeira esteira de desenvolvimento de software &mdash; se √© que pode ser chamada
assim &mdash; que criei foi uma combina√ß√£o de Git, Bash, e GNU Make, com este
grudando programas como <a href=https://gohugo.io>Hugo</a> e <code>rsync</code>. Seu prop√≥sito era automatizar o
deployment do meu site pessoal.</p><p>Git foi usado para versionamento do c√≥digo-fonte, GNU Make foi usado para
simplificar os processos de build e deployment, Hugo foi usado para transformar
Markdown + templates em HTML e CSS, e <code>rsync</code> foi usado para copiar as p√°ginas
geradas para a ra√≠z do servidor Web &mdash; <code>/var/www</code>.</p><p>Para transformar o <code>git push</code> no √∫nico comando necess√°rio para iniciar um build
e fazer deploy do novo conte√∫do, um <a href=https://git-scm.com/docs/githooks#post-receive>hook <code>post-receive</code></a> foi criado
num reposit√≥rio &ldquo;bare&rdquo; hospedado na VPS que servia o website. O hook era nada
mais do que um script shell, mais ou menos assim:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cd /path/to/the/worktree        <span style=color:#75715e># v√° para um clone do repo</span>
</span></span><span style=display:flex><span>git fetch origin                <span style=color:#75715e># obtenha as novas commits</span>
</span></span><span style=display:flex><span>git reset --hard origin/master  <span style=color:#75715e># sincroniza com master</span>
</span></span><span style=display:flex><span>make <span style=color:#f92672>&amp;&amp;</span> make deploy             <span style=color:#75715e># faz o build e o deploy das p√°ginas</span>
</span></span></code></pre></div><p>Contanto que as permiss√µes estivessem corretas e as depend√™ncias instaladas,
tudo que eu precisava fazer para atualizar as p√°ginas do seu site era editar os
arquivos localmente, criar novas commits, e envi√°-las para o remote. Se algum
erro ocorresse, eu conseguiria v√™-lo na sa√≠da do <code>git push</code>, pois este mostra a
sa√≠da dos hooks enquanto s√£o executados.</p><h3 id=por-que-n√£o-houve-integra√ß√£o-cont√≠nua>Por que n√£o houve Integra√ß√£o Cont√≠nua</h3><p>Mesmo com toda minha felicidade na √©poca com minha nova descoberta (hooks do
Git) e minha configura√ß√£o, em retrospecto n√£o d√° para dizer que havia CI. Antes
de listar minhas raz√µes, a seguir est√° a defini√ß√£o de Integra√ß√£o Cont√≠nua dada
pela <a href=https://www.atlassian.com/continuous-delivery/continuous-integration>Atlassian</a>:</p><blockquote><p>Integra√ß√£o Cont√≠nua (CI) √© a pr√°tica de automatizar a integra√ß√£o de mudan√ßas
no c√≥digo feita por m√∫ltiplos contribuidores em um s√≥ projeto de software. √â
uma boa pr√°tica prim√°ria de DevOps, permitindo a desenvolvedores
frequentemente integrar mudan√ßas a um reposit√≥rio central, onde builds e
testes s√£o ent√£o executados.</p></blockquote><p>Apesar dessa defini√ß√£o, eu pessoalmente acredito que pode-se atingir CI mesmo
quando h√° somente um contribuidor, mas se voc√™ discorda de mim, adicione esse
fato √† seguinte lista de raz√µes pelas quais n√£o houve integra√ß√£o cont√≠nua no
projeto em quest√£o.</p><p><strong>Raz√£o #1:</strong> H√° somente um branch &mdash; <code>master</code> &mdash;, portanto mudan√ßas sendo
testadas j√° foram integradas.</p><p>O prop√≥sito de CI √© testar e revisar mudan√ßas antes de integr√°-las ao branch de
destino. Su√≠tes como GitHub, GitLab, Bitbucket, entre outras s√£o extremamente
√∫teis: elas materializam a ideia de proposta de mudan√ßa em pull (ou merge)
requests. Estas requests podem ser negadas, aceitas, revisadas, etc., e ainda
mais legal √© o fato de que quando s√£o criadas ou modificadas, a su√≠te pode nos
notificar programaticamente por meio de webhooks, e at√© tratar dos eventos
nativamente.</p><p>No meu caso, n√£o haviam pull requests: commits eram adicionadas √† <code>master</code> e
empurradas <strong>diretamente upstream,</strong> sem mais nem menos.</p><p><strong>Raz√£o #2:</strong> O √∫nico teste feito √© deployment.</p><p>N√£o h√° teste automatizado de nenhum tipo, nem mesmo para ver se as p√°ginas ainda
seriam geradas. Consigo at√© lembrar de momentos em que quebrei a gera√ß√£o das
p√°ginas enquanto testava as capacidades de template do Hugo &mdash; a vers√£o
instalada na minha m√°quina era diferente da instalada no servidor.</p><p>A falta de um ambiente facilmente reproduzido para testes (e obviamente os
testes em si) significava que todo deployment feito arriscava quebrar a
&ldquo;produ√ß√£o&rdquo;.</p><p><strong>Raz√£o #3:</strong> Mudan√ßas n√£o passam por nenhum processo de revis√£o.</p><p>Para v√°rias pessoas, revis√£o de c√≥digo n√£o est√° necessariamente dentro do escopo
de integra√ß√£o cont√≠nua, mas na minha humilde opini√£o, √© central para esta. Se CI
tem o intuito de controlar ou garantir um grau de qualidade antes de mudan√ßas
entrarem em branches est√°veis, revis√µes est√£o perfeitamente alinhadas com ela, e
ficam no caminho da integra√ß√£o.</p><p>Eu disse antes que <em>acredito que CI pode ser atingida mesmo quando h√° somente um
contribuidor,</em> ent√£o por que levanto esse ponto? A raz√£o √© que eu n√£o revisava
minhas pr√≥prias mudan√ßas. Eu as testava localmente, claro, mas n√£o as revisava
com imparcialidade depois do desenvolvimento. A falta de qualquer processo de
revis√£o, ao meu ver, desclassifica esta esteira de receber o apelido de
integra√ß√£o cont√≠nua.</p><h3 id=por-que-houve-deployment-cont√≠nuo-talvez>Por que houve Deployment Cont√≠nuo (talvez)</h3><p>Se voc√™ espremer bem os olhos, ou for permissivo no acoplamento entre CI e CD, o
setup com Git & Make tinha, sim, deployment cont√≠nuo. Mais uma vez, come√ßamos
com uma defini√ß√£o. Dessa vez, ela vem do <a href=https://www.techtarget.com/searchitoperations/definition/continuous-deployment>TechTarget:</a></p><blockquote><p>Deployment Cont√≠nuo (CD) √© uma estrat√©gia de lan√ßamento de software onde toda
commit que passa pela fase de teste automatizado √© automaticamente lan√ßada no
ambiente de produ√ß√£o, fazendo mudan√ßas vis√≠veis aos seus usu√°rios.</p></blockquote><p>Commits que chegavam √† <code>master</code>, usada para produ√ß√£o no nosso caso, chegariam
automaticamente ao ambiente de produ√ß√£o &mdash; a vers√£o do site servida pelo
servidor. Nesse sentido, isso foi um exemplo de deployment cont√≠nuo, mas <em>se n√£o
h√° CI, pode haver CD?</em> √â necess√°ria a presen√ßa dessa &ldquo;fase de teste autom√°tico&rdquo;
para que o deployment seja cont√≠nuo?</p><p>Eu diria que n√£o. CI e CD s√£o ambos premissas fundamentais da cultura DevOps,
mas a implanta√ß√£o dos dois costuma ser feita separadamente. Fossem eles
genuinamente insepar√°veis, provavelmente ter√≠amos uma express√£o s√≥ a designar a
&ldquo;unidade&rdquo; composta por ambos.</p><h2 id=o-caminho-para-cicd-propriamente-dito>O caminho para CI/CD propriamente dito</h2><p>Meus olhos se abriram para CI/CD quando comecei a trabalhar. At√© ent√£o, mal
sabia o que significavam, se √© que havia realmente ouvido falar dos dois. A mim,
CI era a segunda parte de <a href=https://travis-ci.com>Travis CI</a>, uma ferramenta que rodava
builds no reposit√≥rio do XMonad de forma autom√°tica, e CD era um formato de
m√≠dia √≥tica.</p><p>Come√ßo a trabalhar e quase que de imediato, me deparo com o <a href=https://jenkins.io>Jenkins</a>.
Ele me foi apresentado como a ferramenta de escolha para a maioria dos
desenvolvedores para criar esteiras de CI/CD, e d√° para ver por qu√™. No
entanto, o sentimento que o Jenkins passa, quanto mais experi√™ncia com ele voc√™
adquire, √© de um programa equivalente a um pano de prato feito de v√°rios
remendos e que consome mais recursos do que deve ser necess√°rio.</p><p>Inexperiente e com os olhos brilhando, refletindo uma nova admira√ß√£o pela
constru√ß√£o de esteiras de desenvolvimento, busquei escrever algumas
<code>Jenkinsfile</code>s para automatizar processos como altera√ß√µes no firmware do meu
eReader.</p><p>Criados e configurados reposit√≥rios aqui e ali, lendo a documenta√ß√£o enquanto
pensava &ldquo;rapaz, que trabalheira isso deu, mas vai valer a pena&rdquo;, minha aten√ß√£o
se voltou a <a href=https://github.com/actions>GitHub Actions</a>. S√≥ algumas linhas de YAML e um pouco
de documenta√ß√£o e um workflow estava pronto, o segundo j√° em progresso. O GitHub
lida com tudo nativamente, e at√© roda os workflows de gra√ßa contanto que o
reposit√≥rio continuasse p√∫blico, ou eu n√£o tivesse ultrapassado o limite de
minutos do m√™s.</p><h3 id=o-motivo-de-eu-nem-sempre-querer-usar-jenkins>O motivo de eu nem sempre querer usar Jenkins</h3><p>Aqui vai um exemplo encurtado de uma <code>Jenkinsfile</code> comum, usando a sintaxe de
pipeline declarativa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=display:flex><span>pipeline <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  agent      <span style=color:#f92672>{</span> <span style=color:#75715e>/* ... */</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  options    <span style=color:#f92672>{</span> <span style=color:#75715e>/* ... */</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  parameters <span style=color:#f92672>{</span> <span style=color:#75715e>/* ... */</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  stages <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    stage<span style=color:#f92672>(</span><span style=color:#e6db74>&#39;faz alguma coisa&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      steps <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        agoraSimFazAlgumaCoisa
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>As op√ß√µes de build (<code>options</code>) costumam ocupar m√∫ltiplas linhas, bem como a
especifica√ß√£o de <code>agent</code> e os <code>parameters</code>, no caso de uma pipeline
parametrizada. Em cima disso, uma pipeline com um √∫nico est√°gio √© algo bem
raro, ent√£o replique o est√°gio no arquivo acima alguma vezes. Como que de
costume, cada est√°gio ter√° mais de um <code>step</code>, provavelmente. Ademais, suponha
que a cl√°usula <code>when</code> ser√° usada para pular alguns passos, e agora voc√™ tem
n√≠veis absurdos de indenta√ß√£o e de linhas.</p><p>√â simplesmente cansativo. Necess√°rio, de vez em quando, mas bem cansativo.</p><p>Al√©m disso, quando voc√™ estiver instalando e configurando o Jenkins, √© bom que
voc√™ configure e suba agentes de build, sejam dinamicamente provisionados por
uma &ldquo;cloud&rdquo; ou configurados uma vez e mantidos. Boa sorte gerenciando
depend√™ncias; s√≥ espero que existam imagens <a href=https://docker.com>Docker</a> suficientes para o
seu caso e voc√™ n√£o precise subir um certo &ldquo;repository manager.&rdquo;</p><p><em>Uma √∫ltima coisa:</em> voc√™ vai precisar de plugins? Espero que sejam mantidos e
que n√£o quebrem nas vers√µes mais novas.</p><h3 id=github-actions-poupa-tempo-e-dinheiro>GitHub Actions poupa tempo e dinheiro</h3><p>O Jenkins depende de plugins para sua integra√ß√£o com su√≠tes como GitHub, GitLab,
Bitbucket, etc. Voc√™ tamb√©m precisa configurar um webhook a n√£o ser que queira
consultar o reposit√≥rio periodicamente. Tais plataformas foram inteligentes o
suficiente para aproveitar a oportunidade criada por empresas implementando
CI/CD enquanto hospedam seus reposit√≥rios l√°, e agora t√™m suas pr√≥prias solu√ß√µes
para fazer essa implementa√ß√£o a mais suave poss√≠vel.</p><p><a href=https://github.com/actions>GitHub Actions</a> √© uma dessas solu√ß√µes. O servi√ßo √© gratuito para
reposit√≥rios p√∫blicos, e voc√™ tem 2000 minutos por m√™s de gra√ßa em contas
b√°sicas para usar nos seus reposit√≥rios privados. Quer pular o setup do Jenkins,
o plugin, o webhook e a <code>Jenkinsfile</code>, e rodar <code>make</code> para toda pull request?
Ponha isso aqui em <code>.github/workflows/ci.yaml</code> e seja feliz:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>on</span>: <span style=color:#ae81ff>pull_request</span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>run</span>: <span style=color:#ae81ff>make</span>
</span></span></code></pre></div><p>Fluxos de trabalho mais detalhados precisar√£o de mais linhas, claro, talvez at√©
mais jobs, que s√£o executados em paralelo por padr√£o a n√£o ser que uma rela√ß√£o
de depend√™ncia seja explicitada no c√≥digo. Se voc√™ usar runners hospedados por
conta (self-hosted runners) nas suas execu√ß√µes, voc√™ n√£o precisa pagar um
centavo pelo uso do servi√ßo. Ou seja, voc√™ ainda tem a op√ß√£o de usar sua pr√≥pria
infraestrutura para CI/CD com GitHub Actions.</p><p>J√° falei bem demais de GitHub Actions. Eu n√£o sou patrocinado por eles, s√≥
queria dizer que curto.</p><h3 id=escolhendo-projeto-ferramentas-e-fluxo-de-trabalho>Escolhendo projeto, ferramentas, e fluxo de trabalho</h3><p>N√£o tem jeito melhor de aprender do que o jeito dif√≠cil, e dif√≠cil costuma ser
pular num oceano quando voc√™ mal sabe nadar. <em>Metaforicamente</em> falando, √© claro;
n√£o fa√ßa uma besteira dessas ou voc√™ vai se afogar. No meu caso, a met√°fora se
refere √† escolha de um projeto e das ferramentas que vou usar, e √† elabora√ß√£o e
subsequente implanta√ß√£o de um fluxo de trabalho que funcione bem para mim.</p><p>O projeto que eu escolhi foi a automatiza√ß√£o do setup. configura√ß√£o e deployment
de servi√ßos nos meus servidores baseado em uma lista e alguns poucos outros
par√¢metros. O objetivo √© ser capaz de recriar um servidor do zero se necess√°rio.</p><p>As ferramentas que escolhi:</p><ul><li><em>Git</em> para o controle de vers√£o, por raz√µes √≥bvias.</li><li><em>Docker</em> para os servi√ßos, usando <em>Compose</em> primariamente.</li><li><em>Ansible</em> para o setup dos servidores, devido √† sua idempot√™ncia e porque
queria aprender.</li><li><em>GitHub Actions</em> para os fluxos de trabalho de CI/CD, por raz√µes j√° listadas.</li></ul><p>Por √∫ltimo, o fluxo de trabalho que eu queria era similar ao que obtive com o
Git hook de anos atr√°s, com duas diferen√ßas chave: mudan√ßas passariam todas por
<em>pull requests,</em> que em torno engatilhariam <em>execu√ß√µes de CI,</em> rodando o Ansible
em check mode; as <em>execu√ß√µes de CD</em> s√£o engatilhadas por merges para a <code>master</code>.</p><figure><a href=/media/git-ansible-sketch.png><img src=/media/git-ansible-sketch.png alt="Rascunho do que eu queria, desde git commit at√© a produ√ß√£o."></a><figcaption><p>Rascunho do que eu queria, desde <code>git commit</code> at√© a produ√ß√£o.</p></figcaption></figure><h2 id=aprendendo-ansible>Aprendendo Ansible</h2><p><a href=https://ansible.com>Ansible</a> me foi apresentado uns anos atr√°s, mas eu acabei por
ignor√°-lo completamente. Naquela √©poca eu tinha apenas um servidor pessoal, e o
estava usando como servidor de email al√©m de hospedeiro para o meu site e outros
servi√ßos simples, como o <a href=https://syncplay.pl>Syncplay</a>. N√£o era nem um pouco tentador
aprender a configurar tudo de novo do zero, j√° que isso n√£o aconteceria t√£o cedo
&mdash; e foi uma baita trabalheira chegar at√© l√°.</p><p>Hoje, anos depois, j√° n√£o mantenho um servidor de email pr√≥prio, e meu site
(este) √© hospedado no GitHub Pages, me deixando livre para experimentar com os
servidor<em>es</em> o quanto eu quiser &mdash; n√£o tenho mais requisito algum de uptime.</p><p>O que eu n√£o sabia antes e que fez Ansible saltar aos meus olhos √© o seu
objetivo de ser <em>idempotente:</em> convergir a um estado desejado e se manter l√°
mesmo quando os playbooks s√£o executados repetidas vezes. Um objetivo que vale
muito, mas que traz consigo v√°rias dificuldades.</p><h3 id=m√≥dulos-s√£o-uma-barreira-de-entrada-de-certa-maneira>M√≥dulos s√£o uma barreira de entrada, de certa maneira</h3><p>Uma coisa que existe como uma barreira de entrada no Ansible √© o fato das tasks
dependerem de <em>m√≥dulos,</em> alguns dos quais s√£o embarcados, alguns dos quais s√£o
empacotados no &ldquo;core&rdquo;, e alguns dos quais s√£o oferecidos em &ldquo;galaxies&rdquo; ou seja
l√° como s√£o chamados os pacotes de terceiros.</p><p>Quando se aprende uma linguagem de programa√ß√£o ou markup, tudo de que voc√™
precisa √© aprender sua sintaxe, seus conceitos centrais, seus membros de
primeira classe, e por a√≠ vai. O Ansible usa YAML, e depois de entendidos os
conceitos de <em>task,</em> de <em>play,</em> de <em>playbook,</em> de <em>handler,</em> de <em>variable,</em> e
de <em>role,</em> o pr√≥ximo passo √© explorar os m√≥dulos dispon√≠veis sozinho.</p><p>N√£o quero fazer com isso uma critica severa ao Ansible &mdash; sou f√£ do Ansible,
agora, afinal &mdash;, mas tal fato torna mais dif√≠cil por de imediato os conceitos
adquiridos em pr√°tica. <em>Eu sei o que uma play √©, e estou para escrever meu
primeiro playbook, mas&mldr; como fa√ßo o Ansible garantir a presen√ßa de uma linha
em um arquivo?</em> Aprender os conceitos por tr√°s de fato n√£o te leva √† conclus√£o
de que existe <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/lineinfile_module.html>um m√≥dulo embarcado chamado <code>lineinfile</code></a>.</p><p>√â poss√≠vel usar Ansible sem conhecimento algum de seus m√≥dulos? Com certeza! Se
voc√™ sabe um pouco de shell script, pode escrever plays que n√£o s√£o em muito
diferentes de um script Bash. Para garantir que um certo arquivo perten√ßa ao
usu√°rio e ao grupo certos, por exemplo, voc√™ pode usar o <code>chown</code> e escrever uma
task com o m√≥dulo <code>shell</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Garante que /tmp/hippopotamus pertence ao Max</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>chown max:max /tmp/hippopotamus</span>
</span></span></code></pre></div><p>Funciona, mas o Ansible n√£o sabe o prop√≥sito, as consequ√™ncias, nem o contexto
desta task, por isso s√≥ pode rodar o script toda vida √†s cegas, sem saber se o
<em>estado desejado</em> est√° sendo alcan√ßado. √â este, afinal, o sentido de exist√™ncia
da ferramenta: <em>idempot√™ncia,</em> convergir para um estado e l√° ficar.</p><p>O √∫nico jeito de dar esta no√ß√£o, este saber ao Ansible √© usando um m√≥dulo mais
espec√≠fico. Neste caso em particular, um que gerencia arquivos e suas
propriedades, em vez de um que roda scripts em shell gen√©ricos. Conseguimos o
que queremos com o <a href=https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html>m√≥dulo <code>file</code></a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Garante que /tmp/hippopotamus pertence ao Max</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/tmp/hippopotamus</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>max</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>group</span>: <span style=color:#ae81ff>max</span>
</span></span></code></pre></div><p>Desta forma, se o arquivo pertence a qualquer outro usu√°rio ou grupo, passar√° a
pertencer a <code>max:max</code>, e o Ansible reportar√° que <em>mudan√ßas</em> foram feitas. Se o
arquivo j√° pertence a <code>max:max</code>, a sa√≠da do Ansible mostrar√° o estado da tarefa
como <em>ok</em>, indicando que n√£o precisou fazer nada.</p><p>No exemplo usando <code>shell</code>, o Ansible reportaria <em>sempre</em> que mudan√ßas foram
feitas, j√° que n√£o conseguiria saber se o script precisou fazer mudan√ßas ou n√£o,
muito menos se realmente o fez, somente que teve que rodar o script. D√° para
for√ßar o Ansible a n√£o reportar mudan√ßas, ou reportar mudan√ßas baseado em uma
condi√ß√£o, atr√°ves da chave <code>changed_when</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Garante que /tmp/hippopotamus pertence ao Max</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>chown max:max /tmp/hippopotamus</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>changed_when</span>: <span style=color:#66d9ef>false</span>
</span></span></code></pre></div><p>Note que o mesmo se aplica ao [m√≥dulo <code>command</code>][command], que difere de <code>shell</code>
invocando o comando diretamente, em vez de por meio de uma shell como
<code>/bin/bash</code>. Efetivamente, <code>shell</code> nos permite escrever scripts shell no meio de
nossos playbooks.</p><p>Me peguei pesquisando <em>como fazer X no Ansible</em> com relativa frequ√™ncia no
in√≠cio, j√° que n√£o tenho grande vontade de decorar palavras numa lista de
m√≥dulos. O dia em que decidir fazer tal coisa, as plays nos meus reposit√≥rios
com certeza ser√£o reescritas. No fim, aprender Ansible assemelha-se bastante √†
jornada de expans√£o de vocabul√°rio num idioma <em>humano:</em> a pr√°tica √© necess√°ria.</p><h3 id=como-foi-por-em-pr√°tica>Como foi por em pr√°tica</h3><p>No final, acabei por escrever m√∫ltiplos playbooks, alguns dos quais deixei
p√∫blicos e alguns dos quais mantive privados j√° que cont√™m informa√ß√µes que
prefiro manter em segredo no momento. Um resumo:</p><ul><li>Um playbook que realiza o processo de bootstrap dos servidores com
configura√ß√£o essencial;</li><li>Um playbook para sincronizar a lista de usu√°rios no servidor destino;</li><li>Um playbook para garantir que ferramentas essenciais estejam instaladas;</li><li>Um playbook que liga e desliga servi√ßos para cada servidor.</li></ul><p>√Äs vezes precisei &ldquo;buscar inspira√ß√£o&rdquo; em roles dispon√≠veis online. Nunca as quis
usar de verdade, especialmente devido ao fato de fazerem muito mais do que eu
queria, ou n√£o terem suporte para o que eu usava. Foi um aprendizado legal, mas
a melhor coisa que posso afirmar ter vindo disso tudo √© saber usar o comando
<code>ansible-doc</code>.</p><p>Uma coisa que adoraria abandonar &mdash; e espero um dia n√£o ter pregui√ßa demais
para criar meus pr√≥prios m√≥dulos &mdash; √© a depend√™ncia em tasks que usam o m√≥dulo
<code>stat</code> para decidir pular passos futuros. Cl√°usulas condicionais, das quais isto
√© um equivalente, n√£o s√£o bonitas em Ansible, mesmo que funcionem e nos ajudem a
obter a gloriosa idempot√™ncia. √â uma &ldquo;idempot√™ncia barata&rdquo;, de certa maneira.</p><h2 id=gitops-o-que-√©-e-por-qu√™>GitOps, o que √© e por qu√™</h2><p>Consigo escrever bastante sobre as ferramentas que usei e a forma como as usei,
mas este artigo j√° se estendeu o suficiente. Mais artigos vir√£o explicando e /
ou ensinando a fazer isso e aquilo com as ferramentas com as quais me
familiarizei ao longo do tempo.</p><p>Um des√≠gnio que me motiva bastante ultimamente √© o que a
<a href=https://www.weave.works/blog/what-is-gitops-really>WeaveWorks</a> decidiu chamar de GitOps; um fluxo de trabalho
&mdash; filosofia, diriam alguns &mdash; resumido por &ldquo;um reposit√≥rio Git deveria ser a
√∫nica fonte da verdade.&rdquo; H√° v√°rias poss√≠veis defini√ß√µes, mas esta deve servir:</p><blockquote><p>Um reposit√≥rio Git √© a √∫nica fonte da verdade para o estado desejado do
sistema inteiro. Este estado desejado √© descrito de forma declarativa,
enquanto mecanismos de converg√™ncia s√£o implantados para garantir que ele √©
atingido.</p></blockquote><p>Em outras palavras, <em>mudan√ßas na configura√ß√£o</em> s√£o relacionadas 1:1 a <em>pull
requests</em> em um fluxo de trabalho GitOps.</p><p>Entenda por <em>configura√ß√£o</em> o estado de um sistema, n√£o arquivos de configura√ß√£o
e afins usados por software para alterar seu comportamento. Exclua da√≠ dados
persistentes produzidos pelo uso do sistema &mdash; que, com sorte, n√£o afetam o seu
comportamento general, pois determinismo em software √© bem imprevis√≠vel, ou ao
menos dificilmente gerenci√°vel.</p><p>Apesar deste jeito de fazer deployment ter seus pr√≥prios defeitos ou em algum
momento sofrer um decl√≠nio de popularidade por qualquer raz√£o, ele oferece
<em>agilidade</em> relativa, seguindo fielmente a cultura DevOps e metodologias √°geis
de desenvolvimento.</p><h3 id=como-eu-acho-que-o-alcancei-no-meu-setup>Como eu acho que o alcancei no meu setup</h3><p>A WeaveWorks criou o termo descrevendo um fluxo de trabalho que circula clusters
<a href=https://kubernetes.io/>Kubernetes</a>. Faz bastante sentido falar de descri√ß√µes declarativas do
estado almejado quando objetos Kubernetes t√™m todos o que chamamos de manifesto
YAML. Algumas propriedades s√≥ existem quando o objeto em si est√° &ldquo;no ar&rdquo;, como
aquelas dentro de <code>{.status}</code>, mas tirando isso os objetos em si s√£o
praticamente id√™nticos aos manifestos que os geraram.</p><p>√â poss√≠vel desginar um fluxo de trabalho como <em>GitOps</em> quando ele n√£o envolve
algo como Kubernetes? Pensando um pouco e com uma mente aberta, contanto que o
estado desejado seja declarado em vez de listarmos instru√ß√µes a serem
executadas &mdash; h√° controv√©rsias em dizer que o Ansible satisfaz essa condi√ß√£o
devido √† relev√¢ncia da ordem das tasks &mdash; e hajam mecanismos de converg√™ncia,
<em>d√° para dizer que sim.</em></p><p>Digamos que apesar da ordem de execu√ß√£o das tarefas ser de grande import√¢ncia ao
Ansible, e a aus√™ncia de um esquema de resolu√ß√£o de depend√™ncias &mdash; como que o
Ansible saberia que o pacote <code>certbot</code> precisa estar instalado para podermos
usar o comando <code>certbot</code>? &mdash;, playbooks s√£o uma especifica√ß√£o declarativa do
estado desejado para nossos hosts. <em>Ent√£o</em> estar√≠amos certos em dizer que um
fluxo de trabalho que usa Ansible como mecanismo de converg√™ncia constitui
GitOps.</p><p>Eu acredito que d√° para ignorar as partes do estado do sistema n√£o gerenciadas
pelo Ansible, j√° que h√° &ldquo;partes n√£o contempladas&rdquo; tamb√©m em fluxos de trabalho
envolvendo Kubernetes (pense em autentica√ß√£o ou <code>PersistentVolume</code>s). Sejamos
felizes em dizer que <em>tudo de que precisamos para mudar o sistema √© um <code>git commit</code></em> e contentes na simplicidade dos nossos setups de CI/CD.</p></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/538f1828a225229364fac663e3a9549e8db8e1d9><span class=commit-hash>538f182</span><span class=commit-subject>feat: add tags to existing blog posts</span></a></p><p id=timestamp>Updated May 14, 2023</p></footer></body></html>