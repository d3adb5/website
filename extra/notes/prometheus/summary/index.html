<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Prometheus is an incredibly (the most?) popular tool for monitoring and
alerting, especially in the cloud-native world. It aids in fetching, storing,
and querying metrics from a variety of sources, and can be used to trigger
alerts when certain conditions are met.
Fancy words, what is it, really? You can imagine Prometheus as the annoying
little brother or cousing who periodically hits you with the same question, in
anticipation for when you&rsquo;re going out, playing video games, or preparing food.
In this case, this annoying rugrat is asking &ldquo;how much memory are you using?&rdquo;,
&ldquo;how many requests are you getting?&rdquo;, &ldquo;how many threads are you running?&rdquo;, and
so on."><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Prometheus and metrics-based monitoring</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href=/ class=[]>Home
</a><a href=/blog/ class=[]>Blog
</a><a href=/glob/ class=[]>Glob
</a><a href=/projects/ class=[]>Projects
</a><a href=/about/ class=push-right>About</a></nav><main role=main><article id=content><header><section class=header-line><h1>Prometheus and metrics-based monitoring</h1></section><section class=subheader-line><p class=subtitle>The popular metrics-based monitoring and alerting stack</p></section></header><p>Prometheus is an incredibly (the most?) popular tool for monitoring and
alerting, especially in the cloud-native world. It aids in fetching, storing,
and querying metrics from a variety of sources, and can be used to trigger
alerts when certain conditions are met.</p><p><em>Fancy words, what is it, really?</em> You can imagine Prometheus as the annoying
little brother or cousing who periodically hits you with the same question, in
anticipation for when you&rsquo;re going out, playing video games, or preparing food.
In this case, this annoying rugrat is asking &ldquo;how much memory are you using?&rdquo;,
&ldquo;how many requests are you getting?&rdquo;, &ldquo;how many threads are you running?&rdquo;, and
so on.</p><p>It&rsquo;s not like Prometheus is configured to ask you all these things. Instead, it
is told it can find some information if it prods you on a given endpoint, and
whatever application receives the request to that endpoint is responsible for
telling Prometheus &ldquo;this is the value of this metric, and this is the value of
that metric.&rdquo; <em>Sometimes we call this application an exporter,</em> exposing metric
information in a format that Prometheus can scrape.</p><h2 id=what-do-we-feed-into-prometheus>What do we feed into Prometheus?</h2><p>It&rsquo;s easier to explain things if we know what we&rsquo;re moving around to begin
with. Remember, <em>Prometheus is the one who asks (usually),</em> and here we&rsquo;ll
cover what it is we respond with. Imagine we have a HTTP-capable application
listening in on some port on some host, at endpoint <code>/metrics</code>. Prometheus goes
to <code>GET</code> that endpoint, and we respond with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-promql data-lang=promql><span style=display:flex><span>requests_received <span style=color:#ae81ff>15</span>
</span></span></code></pre></div><p>Now what does that mean? We&rsquo;re letting Prometheus know of a metric called
<code>requests_received</code>, and stating that the value of <code>requests_received</code> for this
sample is 15. Note that we&rsquo;re calling it a <em>sample</em> because Prometheus will be
querying this endpoint periodically.</p><p><em>But what if we want more information on these requests?</em> Say, the IP address
they&rsquo;re coming from. We could identify them when producing this text format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-promql data-lang=promql><span style=display:flex><span>requests_received { from <span style=color:#f92672>=</span> &#34;<span style=color:#e6db74>192.168.0.1</span>&#34; } <span style=color:#ae81ff>12</span>
</span></span><span style=display:flex><span>requests_received { from <span style=color:#f92672>=</span> &#34;<span style=color:#e6db74>192.168.0.7</span>&#34; } <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Now <code>requests_received</code> has overall value 15 in this sample, if you add up the
labeled lines, and if we query Prometheus through its Web UI or through
Grafana, PagerDuty, etc., we can filter for only the samples we care for.</p><p>There&rsquo;s little more to it than that. All parts of the text format other than
the metric name and value are optional, but here they are being used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-promql data-lang=promql><span style=display:flex><span><span style=color:#75715e># This is a comment. I&#39;m almost certain you can&#39;t use this in the middle of a</span>
</span></span><span style=display:flex><span><span style=color:#75715e># line, and there&#39;s definitely no advantage to it. Oh, and empty lines are</span>
</span></span><span style=display:flex><span><span style=color:#75715e># treated just the same: they&#39;re ignored.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The last token in this line is the timestamp in miliseconds since the epoch.</span>
</span></span><span style=display:flex><span>metric_name { label_name <span style=color:#f92672>=</span> &#34;<span style=color:#e6db74>label_value</span>&#34; } <span style=color:#ae81ff>123</span> <span style=color:#ae81ff>1234567890</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># HELP my_metric Example metric with no meaningful value.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># TYPE my_metric counter</span>
</span></span><span style=display:flex><span>my_metric <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Prometheus will interpret comments preceding samples if they begin with <code>HELP</code>
or <code>TYPE</code>, following by the metric name, and between them they may come in any
particular order.</p><h3 id=the-optional-metric-types>The (optional?) metric types</h3><p>There are four core metric types in Prometheus. For the time being, Prometheus
makes no use of the type information and just flattens everything it gets into
untyped time series. It&rsquo;s important to be aware of them, though! They are:</p><ul><li>Counter</li><li>Gauge</li><li>Histogram</li><li>Summary</li></ul><p>A <em>counter</em> is an ever increasing value. In Calculus terms, it&rsquo;s the image of a
function of time that is monotonous and increasing. Number of requests served,
number of bytes moved around, number of errors encountered, those are all valid
examples of counters. Don&rsquo;t use this type for something that may decrease in
value over time; that would make it a gauge.</p><p>A <em>gauge</em> is a value that can increase or decrease. Number of active threads,
number of active clients, memory and CPU usage, etc. If it can go up and down
in value over time, it&rsquo;s a gauge. Makes sense, right?</p><p>Okay, now it stops being intuitive. <em>Histograms</em> and <em>summaries</em> have weird
representations and it&rsquo;s not immediately clear what they&rsquo;re for. <a href=https://prometheus.io/docs/practices/histograms/>The
Prometheus documentation</a> does a far better job at explaining it
than I ever could, not that I understand it well.</p><p>For starters, both of these types generate multiple time series. Two that are
always generated are the ones with <code>_sum</code> and <code>_count</code> suffixes. Respectively,
they represent the sum of all observed values and the number of observations.</p></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/f1b4b65c673dca12cf8224ce85bd3aa295415c40><span class=commit-hash>f1b4b65</span><span class=commit-subject>content: add extra section and move notes into it</span></a></p><p id=timestamp>Updated May 6, 2023</p></footer></body></html>