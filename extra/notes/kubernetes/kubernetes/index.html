<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I&rsquo;ve worked with Kubernetes for a while now, and while the name made it seem a
little daunting at first, it&rsquo;s actually quite simple. In fact it&rsquo;s simple
enough I got Kubernetes certified recently! If I can do it, anyone can. This
page has a few notes on interesting Kubernetes tricks I&rsquo;ve learned during my
time working with it.
What is container orchestration?
It&rsquo;s unclear. Well, it&rsquo;s not unclear, but the words &ldquo;container orchestration&rdquo;
don&rsquo;t really mean anything. To summarize Kubernetes, it&rsquo;s an aggregate of
container runtimes operating on multiple machines &mdash; which we call nodes &mdash;
that host containerized processes grouped together in what we refer to as
Pods. The two main roles Kubernetes plays are:"><meta http-equiv=Content-Security-Policy content="default-src 'self' cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src *; object-src 'none'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net; worker-src 'self' blob:; base-uri 'self'"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><title>Kubernetes, the container orchestrator!</title><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/source-sans-pro-600.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-regular.woff2 crossorigin><link rel=preload as=font type=font/woff2 href=/fonts/inconsolata-600.woff2 crossorigin><style type=text/css>@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:400;src:url(/fonts/source-sans-pro-regular.woff2)format("woff2"),url(/fonts/source-sans-pro-regular.woff)format("woff")}@font-face{font-display:swap;font-family:source sans pro;font-style:normal;font-weight:600;src:url(/fonts/source-sans-pro-600.woff2)format("woff2"),url(/fonts/source-sans-pro-600.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:400;src:url(/fonts/inconsolata-regular.woff2)format("woff2"),url(/fonts/inconsolata-regular.woff)format("woff")}@font-face{font-display:swap;font-family:inconsolata;font-style:normal;font-weight:600;src:url(/fonts/inconsolata-600.woff2)format("woff2"),url(/fonts/inconsolata-600.woff)format("woff")}footer#page-footer,nav#site-nav{background:0 0;padding:1em}footer#page-footer,nav#site-nav{background:#282a2e;color:#c5c8c6;line-height:3em}nav#site-nav{display:flex;overflow:auto;scrollbar-width:none}nav#site-nav::-webkit-scrollbar{display:none}nav#site-nav a{display:inline-block;width:6em;font-weight:700;text-align:center;color:inherit;flex-shrink:0}@media screen and (min-width:60em){footer#page-footer,nav#site-nav{line-height:inherit}}html{background:#252628}body{width:100%;max-width:60em;margin:0 auto;line-height:1.5em;font-family:source sans pro,helvetica,liberation sans,open sans,sans-serif;font-size:100%;color:#c5c8c6}@media screen and (min-width:60em){body{margin:2em auto!important}}h1,h2,h3,h4,h5,h6{margin:1.1em 0 .83em}h1,h2,h3{color:#8c9440}h4,h5,h6{color:#b5bd68}h1{font-size:1.5em}h2{font-size:1.26em}h3{font-size:1.1em}h4{font-size:1.03em}h5{font-size:.67em}h6{font-size:.51em}a{text-decoration:initial;color:#de935f}a:hover{text-decoration:underline}em{color:#f0c674;font-style:normal}strong{color:#c66}nav#site-nav{border-radius:1em 1em 0 0;background:0 0;color:#c5c8c6}nav#site-nav a.push-right{margin-left:auto}nav#site-nav a.current{color:#81a2be}label#toc-toggle{display:flex;width:100%;margin-top:1em;height:3em;align-items:center;justify-content:center}input#toc-toggle-box{display:none}input#toc-toggle-box~nav#TableOfContents{display:none}input#toc-toggle-box:checked~nav#TableOfContents{display:block}nav#TableOfContents{margin:.5em 0 0;box-sizing:border-box;background:#282a2e;padding:1em;border-radius:.5em;overflow:hidden;font-weight:700;color:#de935f}nav#TableOfContents ul{margin:0;padding:0;list-style-type:none}nav#TableOfContents ul li{overflow:hidden;white-space:nowrap;text-overflow:' ...'}nav#TableOfContents ul li+li{margin-top:1em}nav#TableOfContents ul ul{padding-left:1em;margin-top:1em}@media screen and (min-width:60em){nav#TableOfContents{float:right;margin:1em 0 1em 1em;max-width:40%;font-size:85%}nav#TableOfContents ul li+li{margin-top:initial}nav#TableOfContents ul ul{margin-top:initial}}@media screen and (min-width:60em){label#toc-toggle{display:none}}@media screen and (min-width:60em){input#toc-toggle-box~nav#TableOfContents{display:initial}}footer#page-footer{background:0 0;color:#707880;display:grid;grid-auto-flow:column;grid-template-columns:minmax(0,1fr)}footer#page-footer a{color:#f0c674}footer#page-footer span.commit-subject{color:#de935f;margin-left:.5em}footer#page-footer p#commit{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}footer#page-footer p#commit span.commit-hash{font-family:inconsolata,dejavu sans mono,liberation mono,monospace}footer#page-footer p#timestamp,footer#page-footer p#commit{margin:0}footer#page-footer p#timestamp{text-align:right}article{background:#1d1f21;padding:.1em 1.5em .8em}@media screen and (min-width:60em){article{border-radius:.5em}}article header{font-weight:700}article header section.header-line{display:flex;justify-content:space-between;align-items:center}article header section.header-line h1{color:#8c9440;margin-bottom:.25em}article header section.header-line aside#translations{margin:1.1em 0 .25em}article header section.header-line aside#translations ul#translations{list-style:none;padding:0;margin:0;display:flex;justify-content:space-around;font-size:115%}article header section.header-line aside#translations ul#translations li:not(:first-child){margin-left:1em}article header section.subheader-line{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}article header section.subheader-line p.subtitle{color:#5e8d87;margin:0}article header section.subheader-line p.subtitle em{color:inherit;font-style:italic}article header section.subheader-line ul#article-tags{list-style-type:none;padding-left:0;margin:0;font-size:85%}article header section.subheader-line ul#article-tags li{display:inline-block}article header section.subheader-line ul#article-tags li:nth-child(n+2){margin-left:1em}article header section.subheader-line ul#article-tags li a{color:#f0c674}article blockquote{color:#979a98;padding-left:1em;border:0 solid #707880;border-left-width:.5em}article table{width:100%}article table th{color:#81a2be}article table td{color:#c5c8c6}article table td.date{width:1%;white-space:nowrap;padding:0 .5em 0 0}article table.compare-table{border-collapse:collapse}article table.compare-table th,article table.compare-table td{padding:.5em 1em;box-sizing:border-box}article table.compare-table th:first-child,article table.compare-table td:first-child{padding-left:0}article table.compare-table th:last-child,article table.compare-table td:last-child{padding-right:0}article table.compare-table th,article table.compare-table td:nth-child(n+2){text-align:center}article table.compare-table td{border-top:.1em solid #707880}article table.compare-table th:nth-child(n+2){min-width:4em}article li::marker{color:#f0c674}article figure{margin:1.25em 0;text-align:center}article figure img{min-height:5em;max-height:15em;width:100%;object-fit:cover;border-radius:1em}article figure figcaption p{margin-top:0}article code{font-family:inconsolata,dejavu sans mono,liberation mono,monospace;font-size:100%}article pre{background:#282a2e;border-radius:.5em;padding:.5em 1em;overflow-x:auto;line-height:initial}article>hr{color:#707880;opacity:.5;margin:2em 0}article p code,article li code{background:#282a2e;padding:0 .3em;border-radius:.25em}article>p a,article>ul li a,article>ol li a{text-decoration:underline}article.extra-pages h2~p{margin-left:2em}article section.dialog{display:flex;padding:1em;align-content:center;border-radius:.5em;border:.2em solid #707880;margin:.5em 0 0;box-sizing:border-box;max-width:100%}article section.dialog p:first-child{margin-top:0}article section.dialog p:last-child{margin-bottom:0}article section.dialog .dialog-icon{margin-right:1em}article section.dialog.dialog-info{border-color:#5f819d}article section.dialog.dialog-warning{border-color:#de935f}article section.dialog.dialog-error{border-color:#a54242}article section.dialog.dialog-success{border-color:#8c9440}@media screen and (min-width:60em){article section.dialog{margin:1em 0 0}}</style></head><body><nav id=site-nav><a href=/ class=[]>Home
</a><a href=/blog/ class=[]>Blog
</a><a href=/glob/ class=[]>Glob
</a><a href=/projects/ class=[]>Projects
</a><a href=/about/ class=push-right>About</a></nav><main role=main><article id=content><header><section class=header-line><h1>Kubernetes, the container orchestrator!</h1></section><section class=subheader-line><p class=subtitle>Simple, yet much more complicated than it seems&mldr;</p></section></header><nav id=TableOfContents><ul><li><a href=#what-is-container-orchestration>What is container orchestration?</a></li><li><a href=#anatomy-of-a-kubernetes-resource>Anatomy of a Kubernetes resource</a></li><li><a href=#what-kubernetes-cant-do-at-least-ootb>What Kubernetes can&rsquo;t do, at least OOTB</a></li><li><a href=#the-operator-pattern>The operator pattern</a></li></ul></nav><p>I&rsquo;ve worked with Kubernetes for a while now, and while the name made it seem a
little daunting at first, it&rsquo;s actually quite simple. In fact it&rsquo;s simple
enough I got Kubernetes certified recently! If I can do it, anyone can. This
page has a few notes on interesting Kubernetes tricks I&rsquo;ve learned during my
time working with it.</p><h2 id=what-is-container-orchestration>What is container orchestration?</h2><p>It&rsquo;s unclear. Well, it&rsquo;s not unclear, but the words &ldquo;container orchestration&rdquo;
don&rsquo;t really mean anything. To summarize Kubernetes, it&rsquo;s an aggregate of
container runtimes operating on multiple machines &mdash; which we call <em>nodes</em> &mdash;
that host containerized processes grouped together in what we refer to as
<em>Pods.</em> The two main roles Kubernetes plays are:</p><ul><li><em>Connecting everything on a network,</em> meaning abstractions are put in place
to make it easy for one container to talk to another;</li><li><em>Ensuring a desired state is reached,</em> meaning guaranteeing that what should
be running is running.</li></ul><p>If you ever set up a few servers to run your own things, you probably know
computer networks can be a pain. To take control of the network you need to set
up firewall rules, configure DNS, deal with routing, and so on. The moment you
throw your applications into containers &mdash; which you can consider prerequisite
knowledge here &mdash; all of that is taken care of for you.</p><p>The second point is perhaps a little more abstract. Take it to mean Kubernetes
has <em>convergence mechanisms</em> in place. It uses a key-value store called <em>etcd</em>
to store <em>resources</em> that represent different things in the cluster. The
collection of these resources is referred to as the <em>cluster state.</em> Something
like &ldquo;there should be an NGINX instance running&rdquo; can be represented through a
resource.</p><h2 id=anatomy-of-a-kubernetes-resource>Anatomy of a Kubernetes resource</h2><p>While there is a multitude of resources, every resource has at least 4 required
fields:</p><ul><li><code>apiVersion</code>: The version of the Kubernetes API used to create the resource;</li><li><code>kind</code>: The type of the resource itself;</li><li><code>metadata</code>: Unique information about the resource;</li><li><code>spec</code>: The desired state of the resource, as it is specified.</li></ul><p>A YAML file can be used to represent the resource. We call this a <em>manifest.</em>
Here&rsquo;s an example manifest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1      </span> <span style=color:#75715e># This uses &#39;core&#39; API group &#39;v1&#39;.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Pod           </span> <span style=color:#75715e># This resource is a &#39;Pod&#39;.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>my-pod      </span> <span style=color:#75715e># The Pod is called &#39;my-pod&#39;.</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>pods   </span> <span style=color:#75715e># The Pod is in the &#39;pods&#39; namespace.</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>containers</span>:        <span style=color:#75715e># List of containers in the Pod.</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx   </span> <span style=color:#75715e># This container is called &#39;nginx&#39;.</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx  </span> <span style=color:#75715e># It runs the &#39;nginx&#39; image; &#39;:latest&#39; is implied.</span>
</span></span></code></pre></div><h2 id=what-kubernetes-cant-do-at-least-ootb>What Kubernetes can&rsquo;t do, at least OOTB</h2><p>There&rsquo;s plenty that Kubernetes can do for you, but a lot of functionality is
simply not within the scope of the core project itself. For example, while
running services on a Kubernetes cluster one might want to know how much CPU,
memory, and disk are being used by Pods at any given time. This can be done
through metrics servers &mdash; not something Kubernetes provides out of the box. A
few common things you might want:</p><ul><li><p>Want to <em>collect logs</em> and store them somewhere? You&rsquo;re looking for a log
shipper. The kubelet &mdash; a component of Kubernetes that runs on every node
&mdash; will collect logs to disk, but it offers no configuration to have it
shipped elsewhere. You can use something like <a href=https://grafana.com/docs/loki/latest/clients/promtail/>Promtail</a> in a
<code>DaemonSet</code> to ship those logs to Loki, for example.</p></li><li><p>Want to <em>monitor</em> the applications running on your cluster? You&rsquo;re looking
for a monitoring system. Try the <a href=https://github.com/prometheus-operator/prometheus-operator>Prometheus Operator</a>. It
contains a CRD &mdash; custom resource definition &mdash; called a ServiceMonitor
that can be used to collect metrics from Pods.</p></li><li><p>Do you need your services to <em>scale?</em> Kubernetes does come with autoscaling
capabilities through the HorizontalPodAutoscaler, but if you need something
more complicated for whatever reason, perhaps based on events, look into
<a href=https://keda.sh/>KEDA</a>.</p></li></ul><p>While Kubernetes itself is a very thorough project, it&rsquo;s not a silver bullet. A
lot of the functionality you might need is provided by things running on top of
Kubernetes, interfacing with the API in your stead. Get used to the idea and
familiarize yourself with the design patterns that have risen as a result.</p><h2 id=the-operator-pattern>The operator pattern</h2><p>This is perhaps the most prevalent pattern you&rsquo;ll see as you work with
different services deployed to Kubernetes clusters. Operators are programs that
make use of custom resources to manage other applications. Let&rsquo;s use an example
situation to see what kind of problem an operator might solve.</p><p>You&rsquo;re deploying a set of applications that make use of <a href=https://jaegertracing.io>Jaeger</a> for
tracing. To set Jaeger itself up, you need a storage backend like Cassandra or
ElasticSearch, which will also have to be deployed &mdash; hopefully decoupled from
Jaeger so these can all be scaled and made highly available &mdash; and assuming
these are being created from scratch, here&rsquo;s what we need:</p><ol><li>Jaeger will need a Deployment to control its replicas;</li><li>Jaeger will need a Service to expose the replicas to other containers;</li><li>Jaeger will probably need an Ingress to expose its Web UI;</li><li>Jaeger will probably need a ConfigMap for additional configuration;</li><li>Jaeger&rsquo;s storage backend will need all of the above, though likely use a
StatefulSet.</li></ol><p>To make many of the parameters for the resources listed above configurable, our
first instinct will probably be to create a <a href=https://helm.sh>Helm</a> chart. The resources
can be customized through the chart&rsquo;s values, and each time we need to deploy
this configuration, we&rsquo;ll use the chart. This is a valid approach, but may
become unmanageable over time. Instead, how about we use a resource called
<code>Jaeger</code> and have an application closely monitor the cluster, looking for
instances of that resource, and deploying what we need in-place?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>jaegertracing.io/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Jaeger</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>greatest-jaeger-of-all-time</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>storage</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>elasticsearch</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>elasticsearch</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>nodeCount</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ...</span>
</span></span></code></pre></div><p>Depending on the values in the <code>spec</code> field here, this hypothetical application
would deploy a different set of services, be it for storage, access, what have
you. This hypothetical application exists already and its name is <a href=https://github.com/jaegertracing/jaeger-operator/>Jaeger
Operator</a>. This operator in particular doesn&rsquo;t deploy the
storage backend, at least as of the time of this writing. Do check the
documentation if you decide to use this operator.</p><p>The <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/operator/>Kubernetes documentation on the operator pattern</a> does
a much better job than me at explaining and exemplifying it.</p></article></main><footer id=page-footer><p id=commit><a href=https://github.com/d3adb5/website/commit/f1b4b65c673dca12cf8224ce85bd3aa295415c40><span class=commit-hash>f1b4b65</span><span class=commit-subject>content: add extra section and move notes into it</span></a></p><p id=timestamp>Updated May 6, 2023</p></footer></body></html>